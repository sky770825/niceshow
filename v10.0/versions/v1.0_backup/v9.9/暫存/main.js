// Main Â∞àÁî® JavaScript - ÂÆåÂÖ®Áç®Á´ã
// ËºâÂÖ•ÂÖ±‰∫´ÈÖçÁΩÆ

/**
 * ÈñãÂïüÂú∞ÂúñÂ∞éËà™
 * @param {string} url - Google Maps ÈÄ£Áµê
 */
function openMap(url) {
    Utils.openMap(url);
}

/**
 * È°ØÁ§∫ÈÄöÁü•Ë®äÊÅØ
 * @param {string} message - ÈÄöÁü•Ë®äÊÅØ
 * @param {string} type - ÈÄöÁü•È°ûÂûã (info, error)
 */
function showNotification(message, type = 'info') {
    Utils.showNotification(message, type);
}

/**
 * È°ØÁ§∫Âª†ÂïÜËÅØÁµ°Ë≥áË®äÂΩàÁ™ó
 */
function showSponsorContact() {
    const modal = document.getElementById('sponsorModal');
    if (modal) {
        modal.classList.add('show');
        // Èò≤Ê≠¢ËÉåÊôØÊªæÂãï
        document.body.style.overflow = 'hidden';
        
        // Á¢∫‰øùÂΩàÁ™óÂú®Ë¶ñÁ™ó‰∏≠Â§Æ
        setTimeout(() => {
            modal.scrollTop = 0;
            // ÊªæÂãïÂà∞ÂΩàÁ™ó‰ΩçÁΩÆ
            const modalContent = modal.querySelector('.sponsor-modal-content');
            if (modalContent) {
                modalContent.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'center'
                });
            }
        }, 100);
    }
}

/**
 * Èö±ËóèÂª†ÂïÜËÅØÁµ°Ë≥áË®äÂΩàÁ™ó
 */
function hideSponsorContact() {
    const modal = document.getElementById('sponsorModal');
    if (modal) {
        modal.classList.remove('show');
        // ÊÅ¢Âæ©ËÉåÊôØÊªæÂãï
        document.body.style.overflow = '';
    }
}

/**
 * È°ØÁ§∫ÈÜ´ÁôÇË≥áË®äÂΩàÁ™ó
 */
function showMedicalInfo() {
    const modal = document.getElementById('medicalModal');
    if (modal) {
        modal.classList.add('show');
        // Èò≤Ê≠¢ËÉåÊôØÊªæÂãï
        document.body.style.overflow = 'hidden';
        
        // Á¢∫‰øùÂΩàÁ™óÂú®Ë¶ñÁ™ó‰∏≠Â§Æ
        setTimeout(() => {
            modal.scrollTop = 0;
            // ÊªæÂãïÂà∞ÂΩàÁ™ó‰ΩçÁΩÆ
            const modalContent = modal.querySelector('.sponsor-modal-content');
            if (modalContent) {
                modalContent.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'center'
                });
            }
        }, 100);
    }
}

/**
 * Èö±ËóèÈÜ´ÁôÇË≥áË®äÂΩàÁ™ó
 */
function hideMedicalInfo() {
    const modal = document.getElementById('medicalModal');
    if (modal) {
        modal.classList.remove('show');
        // ÊÅ¢Âæ©ËÉåÊôØÊªæÂãï
        document.body.style.overflow = '';
    }
}

/**
 * ÂàáÊèõÈ°ØÁ§∫ÁöÑÈÄ±Ê¨°
 * @param {number} weekNumber - ÈÄ±Ê¨°Á∑®Ëôü (0-6)
 */
function showWeek(weekNumber) {
    // Èö±ËóèÊâÄÊúâÈÄ±ÁöÑÂÖßÂÆπ
    const allWeeks = document.querySelectorAll('.week-content');
    allWeeks.forEach(week => {
        week.classList.remove('active');
    });
    
    // ÁßªÈô§ÊâÄÊúâÂàÜÈ†ÅÁöÑactiveÁãÄÊÖã
    const allTabs = document.querySelectorAll('.week-tab');
    allTabs.forEach(tab => {
        tab.classList.remove('active');
    });
    
    // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÈÄ±
    const targetWeek = document.getElementById(`week${weekNumber}`);
    if (targetWeek) {
        targetWeek.classList.add('active');
    }
    
    // ÊøÄÊ¥ªÂ∞çÊáâÁöÑÂàÜÈ†Å
    if (allTabs[weekNumber]) {
        allTabs[weekNumber].classList.add('active');
    }
    
    // Âπ≥ÊªëÊªæÂãïÂà∞È†ÇÈÉ®
    const content = document.querySelector('.content');
    if (content) {
        content.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }
}

/**
 * ÂàùÂßãÂåñÈ§êËªäÂêçÁ®±ÁöÑÈªûÊìä‰∫ã‰ª∂Âíåtooltip
 */
function initializeTruckNames() {
    const truckNames = document.querySelectorAll('.truck-name');
    truckNames.forEach(nameElement => {
        let locationText = '';
        let mapUrl = '';
        
        // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊúâdata-addressÂ±¨ÊÄß
        if (nameElement.hasAttribute('data-address')) {
            locationText = nameElement.getAttribute('data-address');
            mapUrl = CONFIG.addressMap[locationText];
        } else {
            // Âæû.truck-locationÂÖÉÁ¥†Áç≤ÂèñÂú∞ÂùÄ
            const locationElement = nameElement.parentElement.querySelector('.truck-location');
            if (locationElement) {
                locationText = locationElement.textContent.replace('üìç', '').trim();
                mapUrl = CONFIG.addressMap[locationText];
                
                // Ê∑ªÂä†Âú∞ÂùÄÂà∞data-addressÂ±¨ÊÄß
                nameElement.setAttribute('data-address', locationText);
            }
        }
        
        if (mapUrl) {
            nameElement.style.cursor = 'pointer';
            nameElement.addEventListener('click', function() {
                openMap(mapUrl);
            });
        }
    });
}

/**
 * Ê∑ªÂä†Êó•ÊúüÂç°ÁâáÁöÑ‰∫íÂãïÊïàÊûú
 */
function initializeDayCards() {
    const dayCards = document.querySelectorAll('.day-card');
    dayCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
}

/**
 * Ê∑ªÂä†ÈçµÁõ§Â∞éËà™ÊîØÊè¥
 */
function initializeKeyboardNavigation() {
    document.addEventListener('keydown', function(e) {
        if (e.key >= '1' && e.key <= '7') {
            const weekNumber = parseInt(e.key) - 1;
            if (weekNumber >= 0 && weekNumber <= 6) {
                showWeek(weekNumber);
                // Êõ¥Êñ∞ÂàÜÈ†ÅÁãÄÊÖã
                const allTabs = document.querySelectorAll('.week-tab');
                allTabs.forEach(tab => tab.classList.remove('active'));
                if (allTabs[weekNumber]) {
                    allTabs[weekNumber].classList.add('active');
                }
            }
        }
    });
}

/**
 * Ê∑ªÂä†ÈÄ±Ê¨°Ê®ôÁ±§ÁöÑÈçµÁõ§ÊîØÊè¥
 */
function initializeWeekTabs() {
    const weekTabs = document.querySelectorAll('.week-tab');
    weekTabs.forEach((tab, index) => {
        tab.setAttribute('tabindex', '0');
        tab.setAttribute('role', 'button');
        tab.setAttribute('aria-label', `ÂàáÊèõÂà∞Á¨¨${index + 1}ÈÄ±`);
        
        tab.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                showWeek(index);
                this.classList.add('active');
            }
        });
    });
}

/**
 * Ê∑ªÂä†È†ÅÈù¢ËºâÂÖ•ÂãïÁï´
 */
function initializePageAnimation() {
    // È†ÅÈù¢ËºâÂÖ•ÂãïÁï´
    window.addEventListener('load', function() {
        document.body.classList.add('loaded');
    });

    // Ê∑ªÂä†ËºâÂÖ•ÂãïÁï´
    const container = document.querySelector('.container');
    if (container) {
        container.style.opacity = '0';
        container.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            container.style.transition = 'all 0.6s ease';
            container.style.opacity = '1';
            container.style.transform = 'translateY(0)';
        }, 100);
    }
}

/**
 * ÂàùÂßãÂåñÂúñÁâáË∑ëÁ¢ºÁáà
 */
async function initializeMarquee() {
    const marqueeTrack = document.getElementById('marqueeTrack');
    if (!marqueeTrack) return;
    
    // Ê∏ÖÁ©∫ÁèæÊúâÂÖßÂÆπ
    marqueeTrack.innerHTML = '';
    
    try {
        // ÂÑ™ÂÖàÂæû admin_new.html ÁöÑÊú¨Âú∞ÂÑ≤Â≠òËºâÂÖ•È§êËªäË≥áÊñô
        const adminData = localStorage.getItem('foodTruckData');
        if (adminData) {
            const data = JSON.parse(adminData);
            if (data.foodTrucks && data.foodTrucks.length > 0) {
                console.log('üì± Âæû admin ÂæåÂè∞ËºâÂÖ•Ë∑ëÁ¢ºÁáàÂúñÁâá');
                loadMarqueeImages(data.foodTrucks);
                return;
            }
        }
        
        // ÂòóË©¶ÂæûÂÖ∂‰ªñÊú¨Âú∞ÂÑ≤Â≠òÈçµËºâÂÖ•
        const localData = Utils.storage.get(CONFIG.storageKeys.marqueeImages);
        if (localData && localData.length > 0) {
            console.log('üì± ÂæûÊú¨Âú∞ÂÑ≤Â≠òËºâÂÖ•Ë∑ëÁ¢ºÁáàÂúñÁâá');
            loadMarqueeImages(localData);
            return;
        }
        
        // ÂòóË©¶Âæû data.json ËºâÂÖ•È§êËªäË≥áÊñô
        const response = await fetch('data.json');
        const data = await response.json();
        
        if (data.foodTrucks && data.foodTrucks.length > 0) {
            console.log('üåê Âæû data.json ËºâÂÖ•Ë∑ëÁ¢ºÁáàÂúñÁâá');
            loadMarqueeImages(data.foodTrucks);
            return;
        }
        
        // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞È§êËªäË≥áÊñôÔºå‰ΩøÁî®È†êË®≠Á§∫‰æãÂúñÁâá
        console.log('‚ö†Ô∏è Êú™ÊâæÂà∞È§êËªäÂúñÁâáË≥áÊñôÔºå‰ΩøÁî®È†êË®≠Á§∫‰æãÂúñÁâá');
        loadDefaultMarqueeImages();
        
    } catch (error) {
        console.error('ËºâÂÖ•Ë∑ëÁ¢ºÁáàË≥áÊñôÂ§±Êïó:', error);
        loadDefaultMarqueeImages();
    }
}

/**
 * ËºâÂÖ•Ë∑ëÁ¢ºÁáàÂúñÁâá
 */
function loadMarqueeImages(truckData) {
    const marqueeTrack = document.getElementById('marqueeTrack');
    if (!marqueeTrack) return;
    
    console.log('üîç ËºâÂÖ•ÁöÑÈ§êËªäË≥áÊñô:', truckData);
    
    // ÈÅéÊøæÂá∫Ê¥ªË∫çÁöÑÈ§êËªä
    const activeTrucks = truckData.filter(truck => truck.isActive !== false);
    
    console.log('‚úÖ Ê¥ªË∫çÁöÑÈ§êËªäÊï∏Èáè:', activeTrucks.length);
    
    if (activeTrucks.length === 0) {
        console.log('‚ö†Ô∏è Ê≤íÊúâÊ¥ªË∫çÁöÑÈ§êËªäÔºåËºâÂÖ•È†êË®≠ÂúñÁâá');
        loadDefaultMarqueeImages();
        return;
    }
    
    // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫è
    activeTrucks.sort((a, b) => (a.priority || 0) - (b.priority || 0));
    
    // Âè™È°ØÁ§∫‰∏ÄÊ¨°È§êËªäÔºå‰∏çÈáçË§á
    activeTrucks.forEach(truck => {
        const imgElement = document.createElement('img');
        imgElement.src = truck.src || `https://via.placeholder.com/80x60/667eea/ffffff?text=${encodeURIComponent(truck.title || truck.alt || 'È§êËªä')}`;
        imgElement.alt = truck.alt || truck.title || 'È§êËªä';
        imgElement.style.height = '60px';
        imgElement.style.marginRight = '20px';
        imgElement.style.borderRadius = '8px';
        imgElement.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        imgElement.style.flexShrink = '0';
        imgElement.style.cursor = 'pointer';
        
        // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
        if (truck.imgLink) {
            imgElement.addEventListener('click', () => {
                window.open(truck.imgLink, '_blank', 'noopener,noreferrer');
            });
        }
        
        marqueeTrack.appendChild(imgElement);
    });
    
    // Ê†πÊìöÈ§êËªäÊï∏ÈáèË™øÊï¥ÂãïÁï´ÈÄüÂ∫¶
    marqueeTrack.className = 'marquee-track';
    if (activeTrucks.length === 1) {
        marqueeTrack.classList.add('single-image');
    } else {
        marqueeTrack.classList.add('multiple-images');
    }
    
    console.log(`üñºÔ∏è Ë∑ëÁ¢ºÁáàÂ∑≤ËºâÂÖ• ${activeTrucks.length} ÂÄãÈ§êËªäÂúñÁâáÔºàÁÑ°ÈáçË§áÔºâ`);
}

/**
 * ËºâÂÖ•È†êË®≠Ë∑ëÁ¢ºÁáàÂúñÁâá
 */
function loadDefaultMarqueeImages() {
    const marqueeTrack = document.getElementById('marqueeTrack');
    if (!marqueeTrack) return;
    
    // È†êË®≠Á§∫‰æãÂúñÁâá
    const sampleImages = [
        { src: 'https://via.placeholder.com/80x60/ff6b6b/ffffff?text=QQÁÇ∏ÁÜ±Áãó', alt: 'QQÁÇ∏ÁÜ±ÁãóÈ§êËªä' },
        { src: 'https://via.placeholder.com/80x60/4ecdc4/ffffff?text=ÈªÉ‰Ω≥È¶ô', alt: 'ÈªÉ‰Ω≥È¶ôÁ¢≥ÁÉ§ÁéâÁ±≥' },
        { src: 'https://via.placeholder.com/80x60/45b7d1/ffffff?text=A+happiness', alt: 'A happinessÊâã‰ΩúÂ•∂ÈÖ™' },
        { src: 'https://via.placeholder.com/80x60/96ceb4/ffffff?text=Ëí∏ÁèçÈ£Ω', alt: 'Ëí∏ÁèçÈ£Ω' },
        { src: 'https://via.placeholder.com/80x60/feca57/ffffff?text=ËáßË®òÊéíÈ™®ÈÖ•', alt: 'ËáßË®òÊéíÈ™®ÈÖ•' },
        { src: 'https://via.placeholder.com/80x60/ff9ff3/ffffff?text=Âè∞Êù±ÊîæÂ±±Ë±¨', alt: 'Âè∞Êù±ÊîæÂ±±Ë±¨Áü≥ÊùøÁÉ§ËÇâ' }
    ];
    
    // Ê∑ªÂä†ÂúñÁâáÔºàÈáçË§áÂÖ©Ê¨°‰ª•ÂØ¶ÁèæÁÑ°Á∏´Âæ™Áí∞Ôºâ
    [...sampleImages, ...sampleImages].forEach(img => {
        const imgElement = document.createElement('img');
        imgElement.src = img.src;
        imgElement.alt = img.alt;
        imgElement.style.height = '60px';
        imgElement.style.marginRight = '20px';
        imgElement.style.borderRadius = '8px';
        imgElement.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        imgElement.style.flexShrink = '0';
        marqueeTrack.appendChild(imgElement);
    });
    
    console.log('üñºÔ∏è Ë∑ëÁ¢ºÁáàÂ∑≤ËºâÂÖ•È†êË®≠Á§∫‰æãÂúñÁâá');
}

/**
 * ÂàùÂßãÂåñÊâÄÊúâÂäüËÉΩ
 */
function initializeApp() {
    console.log('üçΩÔ∏è ÂõõÁ∂≠ÂïÜÂúàÈ§êËªäÊúàË°åÁ®ãË°®Â∑≤ËºâÂÖ•ÂÆåÊàêÔºÅ');
    
    // ÂàùÂßãÂåñÂêÑÁ®ÆÂäüËÉΩ
    initializeTruckNames();
    initializeDayCards();
    initializeKeyboardNavigation();
    initializeWeekTabs();
    initializePageAnimation();
    initializeMarquee();
}

// È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂü∑Ë°åÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', initializeApp);
