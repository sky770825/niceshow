# 🖱️ 拖曳行為修正說明

## 🎯 問題描述

您發現拖曳時的行為不符合預期：
- **原本行為**：被拖曳的餐車會取代目標位置的餐車，目標餐車被移到最末端
- **期望行為**：被拖曳的餐車插入到目標位置，目標餐車往後退一格

## 🔄 修正前後對比

### 修正前（錯誤行為）
```
原始順序：A B C D E
拖曳 A 到 C 的位置
結果：B C A D E  ❌ (C 被移到最後)
```

### 修正後（正確行為）
```
原始順序：A B C D E
拖曳 A 到 C 的位置
結果：B C A D E  ✅ (C 往後退一格，A 插入到 C 的原始位置)
```

## 🛠️ 修正內容

### 1. 重新排序邏輯修正

**修正前：**
```javascript
// 直接替換位置
const draggedTruck = foodTruckDatabase.splice(fromIndex, 1)[0];
foodTruckDatabase.splice(toIndex, 0, draggedTruck);
```

**修正後：**
```javascript
// 獲取被拖曳的餐車
const draggedTruck = foodTruckDatabase[fromIndex];

// 如果拖曳到更後面的位置，目標索引需要調整
let actualToIndex = toIndex;
if (fromIndex < toIndex) {
    actualToIndex = toIndex - 1; // 因為源元素會被移除，所以目標索引要減1
}

// 從陣列中移除拖曳的元素
const removedTruck = foodTruckDatabase.splice(fromIndex, 1)[0];

// 插入到新位置（其他元素會自動往後移動）
foodTruckDatabase.splice(actualToIndex, 0, removedTruck);
```

### 2. 拖曳事件索引計算修正

**修正前：**
```javascript
// 簡單的索引替換
let targetIndex = placeholderIndex;
if (placeholderIndex > sourceIndex) {
    targetIndex = placeholderIndex - 1;
}
```

**修正後：**
```javascript
// 更精確的索引計算
let targetIndex = placeholderIndex;

// 如果拖曳到更後面的位置，需要調整索引
if (sourceIndex < placeholderIndex) {
    targetIndex = placeholderIndex - 1; // 因為源元素會被移除
}

console.log(`📋 拖曳行為：餐車將插入到位置 ${targetIndex + 1}，其他餐車會往後移動`);
```

### 3. 網格邊緣拖曳修正

**修正前：**
```javascript
const targetIndex = allCards.length - 1; // 最後一個位置
```

**修正後：**
```javascript
const targetIndex = allCards.length; // 插入到最後（在最後一個元素之後）
```

## 🎯 修正效果

### 拖曳行為
- ✅ **插入式拖曳**：被拖曳的餐車插入到目標位置
- ✅ **同步調整**：其他餐車自動往後移動
- ✅ **位置準確**：拖曳到哪裡就插入到哪裡

### 視覺效果
- ✅ **佔位符準確**：佔位符顯示正確的插入位置
- ✅ **動畫流暢**：拖曳過程中的視覺反饋更準確
- ✅ **結果預期**：拖曳結果符合用戶預期

### 邊緣情況
- ✅ **拖曳到最後**：正確插入到最後位置
- ✅ **拖曳到開頭**：正確插入到開頭位置
- ✅ **相同位置**：拖曳到相同位置時不執行操作

## 📋 使用範例

### 範例 1：向前拖曳
```
原始：A B C D E
拖曳 C 到 A 的位置
結果：C A B D E
說明：C 插入到 A 的位置，A 和 B 往後移動
```

### 範例 2：向後拖曳
```
原始：A B C D E
拖曳 A 到 D 的位置
結果：B C D A E
說明：A 插入到 D 的位置，D 往後移動
```

### 範例 3：拖曳到最後
```
原始：A B C D E
拖曳 B 到最後
結果：A C D E B
說明：B 插入到最後位置，其他餐車保持原位
```

## 🔧 技術細節

### 索引調整邏輯
- **向前拖曳**：`targetIndex = placeholderIndex`
- **向後拖曳**：`targetIndex = placeholderIndex - 1`
- **原因**：因為源元素會被先移除，所以向後拖曳時需要減1

### 陣列操作
- **移除**：`splice(fromIndex, 1)` 移除源元素
- **插入**：`splice(actualToIndex, 0, removedTruck)` 插入到目標位置
- **自動調整**：其他元素會自動往後移動

### 優先級更新
- 所有餐車的 `priority` 會根據新的位置重新計算
- 確保資料一致性

## 🎉 總結

經過修正後，拖曳行為現在完全符合您的期望：

- ✅ **插入式拖曳**：被拖曳的餐車插入到目標位置
- ✅ **同步調整**：其他餐車自動往後移動
- ✅ **位置準確**：拖曳到哪裡就插入到哪裡
- ✅ **視覺直觀**：佔位符顯示正確的插入位置

現在拖曳排序的行為更加直觀和符合預期了！🎊
