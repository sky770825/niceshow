<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™åŒæ­¥æ¸¬è©¦</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 1rem;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-warning {
            background: #f59e0b;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .data-info {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª è³‡æ–™åŒæ­¥æ¸¬è©¦</h1>
        <p>æ¸¬è©¦ F5 é‡æ–°è¼‰å…¥å’Œå¼·åˆ¶é‡æ–°è¼‰å…¥çš„å·®ç•°</p>
        
        <div>
            <button class="btn" onclick="testF5Reload()">ğŸ”„ æ¨¡æ“¬ F5 é‡æ–°è¼‰å…¥</button>
            <button class="btn btn-warning" onclick="testForceReload()">ğŸ”„ æ¨¡æ“¬å¼·åˆ¶é‡æ–°è¼‰å…¥</button>
            <button class="btn btn-success" onclick="simulateDataUpdate()">ğŸ“ æ¨¡æ“¬è³‡æ–™æ›´æ–°</button>
            <button class="btn" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
        
        <div id="status"></div>
        
        <div class="data-info">
            <h3>ğŸ“Š ç›®å‰è³‡æ–™ç‹€æ…‹</h3>
            <div id="dataInfo">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div>
            <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
            <div id="log" class="log">ç­‰å¾…æ¸¬è©¦é–‹å§‹...\n</div>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        let dataInfoElement = document.getElementById('dataInfo');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function showStatus(message, type = 'success') {
            statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateDataInfo() {
            const localData = localStorage.getItem('foodTruckData');
            const dataInfo = {
                hasLocalData: !!localData,
                localDataSize: localData ? localData.length : 0,
                lastUpdate: localData ? JSON.parse(localData).lastUpdated : 'ç„¡'
            };
            
            dataInfoElement.innerHTML = `
                <p><strong>æœ¬åœ°è³‡æ–™:</strong> ${dataInfo.hasLocalData ? 'æœ‰' : 'ç„¡'}</p>
                <p><strong>è³‡æ–™å¤§å°:</strong> ${dataInfo.localDataSize} å­—å…ƒ</p>
                <p><strong>æœ€å¾Œæ›´æ–°:</strong> ${dataInfo.lastUpdate}</p>
            `;
        }
        
        // æ¨¡æ“¬é¤è»Šè³‡æ–™
        let foodTruckDatabase = [
            {
                id: 'truck_001',
                title: 'æ¸¬è©¦é¤è»Š1',
                src: 'https://example.com/image1.jpg',
                isActive: true,
                priority: 1
            },
            {
                id: 'truck_002',
                title: 'æ¸¬è©¦é¤è»Š2',
                src: 'https://example.com/image2.jpg',
                isActive: true,
                priority: 2
            }
        ];
        
        // æ¨¡æ“¬ loadFoodTruckData å‡½æ•¸
        async function loadFoodTruckData(forceRemote = false) {
            log('ğŸ”„ é–‹å§‹è¼‰å…¥é¤è»Šè³‡æ–™...');
            
            try {
                if (forceRemote) {
                    log('ğŸŒ å¼·åˆ¶å¾ data.json è¼‰å…¥æœ€æ–°è³‡æ–™...');
                    return await loadFromRemote();
                } else {
                    log('ğŸ§  æ™ºèƒ½è¼‰å…¥ï¼šæª¢æŸ¥é ç«¯æ›´æ–°...');
                    
                    try {
                        const remoteResult = await loadFromRemote();
                        if (remoteResult.success) {
                            return remoteResult;
                        }
                    } catch (error) {
                        log('âš ï¸ é ç«¯è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦æœ¬åœ°è¼‰å…¥');
                    }
                    
                    return await loadFromLocal();
                }
                
            } catch (error) {
                log(`âŒ è¼‰å…¥é¤è»Šè³‡æ–™å¤±æ•—: ${error.message}`);
                return await loadFromDefault();
            }
        }
        
        // å¾é ç«¯è¼‰å…¥è³‡æ–™
        async function loadFromRemote() {
            log('ğŸŒ å¾ data.json è¼‰å…¥è³‡æ–™...');
            
            try {
                const response = await fetch('data.json?' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (!data || !data.foodTrucks || !Array.isArray(data.foodTrucks)) {
                    throw new Error('data.json æ ¼å¼ä¸æ­£ç¢º');
                }
                
                foodTruckDatabase = data.foodTrucks;
                
                // å„²å­˜åˆ°æœ¬åœ°
                localStorage.setItem('foodTruckData', JSON.stringify(data));
                sessionStorage.setItem('foodTruckData', JSON.stringify(data));
                
                log(`ğŸŒ å¾ data.json è¼‰å…¥æœ€æ–°è³‡æ–™: ${foodTruckDatabase.length} å€‹é¤è»Š`);
                return { success: true, source: 'data.json', count: foodTruckDatabase.length };
                
            } catch (error) {
                log(`âŒ é ç«¯è¼‰å…¥å¤±æ•—: ${error.message}`);
                throw error;
            }
        }
        
        // å¾æœ¬åœ°è¼‰å…¥è³‡æ–™
        async function loadFromLocal() {
            log('ğŸ“± å¾ localStorage è¼‰å…¥è³‡æ–™...');
            
            const localData = localStorage.getItem('foodTruckData');
            if (!localData) {
                throw new Error('localStorage ä¸­æ²’æœ‰è³‡æ–™');
            }
            
            const data = JSON.parse(localData);
            if (!data || !data.foodTrucks || !Array.isArray(data.foodTrucks) || data.foodTrucks.length === 0) {
                throw new Error('localStorage è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©º');
            }
            
            foodTruckDatabase = data.foodTrucks;
            log(`ğŸ“± å¾æœ¬åœ°å„²å­˜è¼‰å…¥è³‡æ–™: ${foodTruckDatabase.length} å€‹é¤è»Š`);
            return { success: true, source: 'localStorage', count: foodTruckDatabase.length };
        }
        
        // ä½¿ç”¨é è¨­è³‡æ–™
        async function loadFromDefault() {
            log('âš ï¸ ä½¿ç”¨é è¨­è³‡æ–™');
            showAlert('ä½¿ç”¨é è¨­é¤è»Šè³‡æ–™', 'warning');
            return { success: false, source: 'default', count: foodTruckDatabase.length, error: 'æ‰€æœ‰è¼‰å…¥æ–¹å¼éƒ½å¤±æ•—' };
        }
        
        // æ¨¡æ“¬ F5 é‡æ–°è¼‰å…¥
        async function testF5Reload() {
            log('ğŸ§ª é–‹å§‹æ¸¬è©¦ F5 é‡æ–°è¼‰å…¥...');
            showStatus('æ­£åœ¨æ¸¬è©¦ F5 é‡æ–°è¼‰å…¥...', 'warning');
            
            try {
                const result = await loadFoodTruckData(false); // æ™ºèƒ½è¼‰å…¥
                log(`ğŸ“Š è¼‰å…¥çµæœ: ${JSON.stringify(result)}`);
                
                updateDataInfo();
                
                if (result.success) {
                    showStatus(`âœ… F5 é‡æ–°è¼‰å…¥æˆåŠŸ: ${result.count} å€‹é¤è»Š (ä¾†æº: ${result.source})`, 'success');
                } else {
                    showStatus('âš ï¸ F5 é‡æ–°è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™', 'warning');
                }
            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
                showStatus(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ¨¡æ“¬å¼·åˆ¶é‡æ–°è¼‰å…¥
        async function testForceReload() {
            log('ğŸ§ª é–‹å§‹æ¸¬è©¦å¼·åˆ¶é‡æ–°è¼‰å…¥...');
            showStatus('æ­£åœ¨æ¸¬è©¦å¼·åˆ¶é‡æ–°è¼‰å…¥...', 'warning');
            
            try {
                // æ¸…é™¤å¿«å–
                localStorage.removeItem('foodTruckData');
                sessionStorage.removeItem('foodTruckData');
                log('ğŸ—‘ï¸ å·²æ¸…é™¤æœ¬åœ°å¿«å–');
                
                const result = await loadFoodTruckData(true); // å¼·åˆ¶é ç«¯è¼‰å…¥
                log(`ğŸ“Š è¼‰å…¥çµæœ: ${JSON.stringify(result)}`);
                
                updateDataInfo();
                
                if (result.success) {
                    showStatus(`âœ… å¼·åˆ¶é‡æ–°è¼‰å…¥æˆåŠŸ: ${result.count} å€‹é¤è»Š (ä¾†æº: ${result.source})`, 'success');
                } else {
                    showStatus('âš ï¸ å¼·åˆ¶é‡æ–°è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™', 'warning');
                }
            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
                showStatus(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ¨¡æ“¬è³‡æ–™æ›´æ–°
        function simulateDataUpdate() {
            log('ğŸ“ æ¨¡æ“¬è³‡æ–™æ›´æ–°...');
            
            // æ›´æ–°é¤è»Šè³‡æ–™
            foodTruckDatabase[0].title = 'æ›´æ–°å¾Œçš„é¤è»Š1 - ' + new Date().toLocaleTimeString();
            foodTruckDatabase[1].title = 'æ›´æ–°å¾Œçš„é¤è»Š2 - ' + new Date().toLocaleTimeString();
            
            // å„²å­˜åˆ°æœ¬åœ°
            const data = {
                foodTrucks: foodTruckDatabase,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('foodTruckData', JSON.stringify(data));
            sessionStorage.setItem('foodTruckData', JSON.stringify(data));
            
            updateDataInfo();
            showStatus('âœ… è³‡æ–™å·²æ›´æ–°ä¸¦å„²å­˜åˆ°æœ¬åœ°', 'success');
            log('âœ… è³‡æ–™æ›´æ–°å®Œæˆ');
        }
        
        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            log('ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™...');
            localStorage.removeItem('foodTruckData');
            sessionStorage.removeItem('foodTruckData');
            
            updateDataInfo();
            showStatus('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ è³‡æ–™åŒæ­¥æ¸¬è©¦é é¢å·²è¼‰å…¥');
            updateDataInfo();
            testF5Reload();
        });
    </script>
</body>
</html>
