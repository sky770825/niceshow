<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料載入測試</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 1rem;
        }
        .btn:hover {
            background: #2563eb;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 資料載入測試</h1>
        <p>測試修復後的資料載入和初始化功能</p>
        
        <div>
            <button class="btn" onclick="testNormalLoad()">🔄 正常載入測試</button>
            <button class="btn" onclick="testForceReload()">🔄 強制重新載入測試</button>
            <button class="btn" onclick="testCorruptedData()">💥 損壞資料測試</button>
            <button class="btn" onclick="clearAllData()">🗑️ 清除所有資料</button>
        </div>
        
        <div id="status"></div>
        
        <div>
            <h3>📝 測試日誌</h3>
            <div id="log" class="log">等待測試開始...\n</div>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function showStatus(message, type = 'success') {
            statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // 模擬 admin.html 的資料載入邏輯
        let foodTruckDatabase = [
            {
                id: 'truck_001',
                title: '測試餐車1',
                src: 'https://example.com/image1.jpg',
                isActive: true,
                priority: 1
            },
            {
                id: 'truck_002',
                title: '測試餐車2',
                src: 'https://example.com/image2.jpg',
                isActive: true,
                priority: 2
            }
        ];
        let filteredTrucks = [];
        let selectedTrucks = new Set();
        
        // 模擬 loadFoodTruckData 函數
        async function loadFoodTruckData() {
            log('🔄 開始載入餐車資料...');
            
            try {
                // 1. 嘗試從 localStorage 載入
                const localData = localStorage.getItem('foodTruckData');
                if (localData) {
                    try {
                        const data = JSON.parse(localData);
                        if (data && data.foodTrucks && Array.isArray(data.foodTrucks) && data.foodTrucks.length > 0) {
                            foodTruckDatabase = data.foodTrucks;
                            log(`📱 從本地儲存載入資料: ${foodTruckDatabase.length} 個餐車`);
                            return { success: true, source: 'localStorage', count: foodTruckDatabase.length };
                        } else {
                            log('⚠️ localStorage 資料格式不正確或為空，嘗試從 data.json 載入');
                        }
                    } catch (parseError) {
                        log('⚠️ localStorage 資料解析失敗，嘗試從 data.json 載入');
                    }
                }
                
                // 2. 從 data.json 載入
                log('🌐 從 data.json 載入資料...');
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (!data || !data.foodTrucks || !Array.isArray(data.foodTrucks)) {
                    throw new Error('data.json 格式不正確');
                }
                
                foodTruckDatabase = data.foodTrucks;
                
                // 3. 儲存到本地
                localStorage.setItem('foodTruckData', JSON.stringify(data));
                log(`🌐 從 data.json 載入資料並儲存到本地: ${foodTruckDatabase.length} 個餐車`);
                return { success: true, source: 'data.json', count: foodTruckDatabase.length };
                
            } catch (error) {
                log(`❌ 載入餐車資料失敗: ${error.message}`);
                log('⚠️ 使用預設資料');
                
                // 4. 使用預設資料作為最後備案
                if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                    log('🔄 初始化預設餐車資料...');
                }
                
                return { success: false, source: 'default', count: foodTruckDatabase.length, error: error.message };
            }
        }
        
        // 模擬 validateData 函數
        function validateData() {
            log('🔍 驗證資料完整性...');
            
            if (!foodTruckDatabase || !Array.isArray(foodTruckDatabase)) {
                log('❌ foodTruckDatabase 不是有效陣列');
                return false;
            }
            
            let validCount = 0;
            foodTruckDatabase.forEach((truck, index) => {
                if (truck && truck.id && truck.title && truck.src) {
                    validCount++;
                } else {
                    log(`⚠️ 餐車 ${index} 資料不完整:`, truck);
                }
            });
            
            log(`📊 資料驗證結果: ${validCount}/${foodTruckDatabase.length} 個有效餐車`);
            return validCount > 0;
        }
        
        // 模擬 repairData 函數
        function repairData() {
            log('🔧 開始修復資料...');
            
            if (!foodTruckDatabase || !Array.isArray(foodTruckDatabase)) {
                log('🔧 修復 foodTruckDatabase 陣列');
                foodTruckDatabase = [];
            }
            
            foodTruckDatabase = foodTruckDatabase.filter(truck => {
                if (!truck || typeof truck !== 'object') return false;
                if (!truck.id || !truck.title || !truck.src) return false;
                return true;
            });
            
            foodTruckDatabase.forEach((truck, index) => {
                truck.priority = index + 1;
                if (!truck.isActive) truck.isActive = true;
                if (!truck.category) truck.category = 'main';
            });
            
            log(`🔧 資料修復完成: ${foodTruckDatabase.length} 個有效餐車`);
            return foodTruckDatabase.length;
        }
        
        // 模擬 initializeData 函數
        function initializeData() {
            log('🔄 初始化資料狀態...');
            
            const isValid = validateData();
            
            if (!isValid) {
                log('🔧 資料無效，開始修復...');
                const repairedCount = repairData();
                log(`🔧 修復完成: ${repairedCount} 個餐車`);
            }
            
            if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                log('⚠️ foodTruckDatabase 為空，使用預設資料');
            }
            
            filteredTrucks = [...foodTruckDatabase];
            
            if (!selectedTrucks || !(selectedTrucks instanceof Set)) {
                selectedTrucks = new Set();
            }
            
            log(`✅ 資料初始化完成: ${foodTruckDatabase.length} 個餐車`);
            
            return {
                foodTruckCount: foodTruckDatabase.length,
                filteredCount: filteredTrucks.length,
                hasData: foodTruckDatabase.length > 0,
                isValid: isValid
            };
        }
        
        // 測試函數
        async function testNormalLoad() {
            log('🧪 開始正常載入測試...');
            showStatus('正在測試正常載入...', 'warning');
            
            try {
                const loadResult = await loadFoodTruckData();
                log(`📊 載入結果: ${JSON.stringify(loadResult)}`);
                
                const initResult = initializeData();
                log(`🔧 初始化結果: ${JSON.stringify(initResult)}`);
                
                if (initResult.hasData) {
                    showStatus(`✅ 正常載入成功: ${initResult.foodTruckCount} 個餐車`, 'success');
                } else {
                    showStatus('⚠️ 正常載入失敗，使用預設資料', 'warning');
                }
            } catch (error) {
                log(`❌ 測試失敗: ${error.message}`);
                showStatus(`❌ 測試失敗: ${error.message}`, 'error');
            }
        }
        
        async function testForceReload() {
            log('🧪 開始強制重新載入測試...');
            showStatus('正在測試強制重新載入...', 'warning');
            
            try {
                localStorage.removeItem('foodTruckData');
                sessionStorage.removeItem('foodTruckData');
                log('🗑️ 已清除本地快取');
                
                const loadResult = await loadFoodTruckData();
                log(`📊 載入結果: ${JSON.stringify(loadResult)}`);
                
                const initResult = initializeData();
                log(`🔧 初始化結果: ${JSON.stringify(initResult)}`);
                
                if (initResult.hasData) {
                    showStatus(`✅ 強制重新載入成功: ${initResult.foodTruckCount} 個餐車`, 'success');
                } else {
                    showStatus('⚠️ 強制重新載入失敗，使用預設資料', 'warning');
                }
            } catch (error) {
                log(`❌ 測試失敗: ${error.message}`);
                showStatus(`❌ 測試失敗: ${error.message}`, 'error');
            }
        }
        
        function testCorruptedData() {
            log('🧪 開始損壞資料測試...');
            showStatus('正在測試損壞資料處理...', 'warning');
            
            try {
                // 模擬損壞的資料
                foodTruckDatabase = [
                    { id: 'truck_001', title: '正常餐車', src: 'https://example.com/image1.jpg' },
                    { id: 'truck_002', title: '', src: 'https://example.com/image2.jpg' }, // 缺少標題
                    { id: '', title: '餐車3', src: 'https://example.com/image3.jpg' }, // 缺少ID
                    null, // 空值
                    { title: '餐車5', src: 'https://example.com/image5.jpg' }, // 缺少ID
                ];
                
                log('💥 設定損壞的測試資料');
                
                const initResult = initializeData();
                log(`🔧 初始化結果: ${JSON.stringify(initResult)}`);
                
                if (initResult.hasData) {
                    showStatus(`✅ 損壞資料修復成功: ${initResult.foodTruckCount} 個有效餐車`, 'success');
                } else {
                    showStatus('⚠️ 損壞資料修復失敗', 'warning');
                }
            } catch (error) {
                log(`❌ 測試失敗: ${error.message}`);
                showStatus(`❌ 測試失敗: ${error.message}`, 'error');
            }
        }
        
        function clearAllData() {
            log('🗑️ 清除所有資料...');
            localStorage.removeItem('foodTruckData');
            sessionStorage.removeItem('foodTruckData');
            foodTruckDatabase = [];
            filteredTrucks = [];
            selectedTrucks = new Set();
            showStatus('✅ 所有資料已清除', 'success');
        }
        
        // 頁面載入時自動測試
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 資料載入測試頁面已載入');
            testNormalLoad();
        });
    </script>
</body>
</html>
