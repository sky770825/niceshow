<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™è¼‰å…¥æ¸¬è©¦</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 1rem;
        }
        .btn:hover {
            background: #2563eb;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª è³‡æ–™è¼‰å…¥æ¸¬è©¦</h1>
        <p>æ¸¬è©¦ä¿®å¾©å¾Œçš„è³‡æ–™è¼‰å…¥å’Œåˆå§‹åŒ–åŠŸèƒ½</p>
        
        <div>
            <button class="btn" onclick="testNormalLoad()">ğŸ”„ æ­£å¸¸è¼‰å…¥æ¸¬è©¦</button>
            <button class="btn" onclick="testForceReload()">ğŸ”„ å¼·åˆ¶é‡æ–°è¼‰å…¥æ¸¬è©¦</button>
            <button class="btn" onclick="testCorruptedData()">ğŸ’¥ æå£è³‡æ–™æ¸¬è©¦</button>
            <button class="btn" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
        
        <div id="status"></div>
        
        <div>
            <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
            <div id="log" class="log">ç­‰å¾…æ¸¬è©¦é–‹å§‹...\n</div>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function showStatus(message, type = 'success') {
            statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // æ¨¡æ“¬ admin.html çš„è³‡æ–™è¼‰å…¥é‚è¼¯
        let foodTruckDatabase = [
            {
                id: 'truck_001',
                title: 'æ¸¬è©¦é¤è»Š1',
                src: 'https://example.com/image1.jpg',
                isActive: true,
                priority: 1
            },
            {
                id: 'truck_002',
                title: 'æ¸¬è©¦é¤è»Š2',
                src: 'https://example.com/image2.jpg',
                isActive: true,
                priority: 2
            }
        ];
        let filteredTrucks = [];
        let selectedTrucks = new Set();
        
        // æ¨¡æ“¬ loadFoodTruckData å‡½æ•¸
        async function loadFoodTruckData() {
            log('ğŸ”„ é–‹å§‹è¼‰å…¥é¤è»Šè³‡æ–™...');
            
            try {
                // 1. å˜—è©¦å¾ localStorage è¼‰å…¥
                const localData = localStorage.getItem('foodTruckData');
                if (localData) {
                    try {
                        const data = JSON.parse(localData);
                        if (data && data.foodTrucks && Array.isArray(data.foodTrucks) && data.foodTrucks.length > 0) {
                            foodTruckDatabase = data.foodTrucks;
                            log(`ğŸ“± å¾æœ¬åœ°å„²å­˜è¼‰å…¥è³‡æ–™: ${foodTruckDatabase.length} å€‹é¤è»Š`);
                            return { success: true, source: 'localStorage', count: foodTruckDatabase.length };
                        } else {
                            log('âš ï¸ localStorage è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºï¼Œå˜—è©¦å¾ data.json è¼‰å…¥');
                        }
                    } catch (parseError) {
                        log('âš ï¸ localStorage è³‡æ–™è§£æå¤±æ•—ï¼Œå˜—è©¦å¾ data.json è¼‰å…¥');
                    }
                }
                
                // 2. å¾ data.json è¼‰å…¥
                log('ğŸŒ å¾ data.json è¼‰å…¥è³‡æ–™...');
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (!data || !data.foodTrucks || !Array.isArray(data.foodTrucks)) {
                    throw new Error('data.json æ ¼å¼ä¸æ­£ç¢º');
                }
                
                foodTruckDatabase = data.foodTrucks;
                
                // 3. å„²å­˜åˆ°æœ¬åœ°
                localStorage.setItem('foodTruckData', JSON.stringify(data));
                log(`ğŸŒ å¾ data.json è¼‰å…¥è³‡æ–™ä¸¦å„²å­˜åˆ°æœ¬åœ°: ${foodTruckDatabase.length} å€‹é¤è»Š`);
                return { success: true, source: 'data.json', count: foodTruckDatabase.length };
                
            } catch (error) {
                log(`âŒ è¼‰å…¥é¤è»Šè³‡æ–™å¤±æ•—: ${error.message}`);
                log('âš ï¸ ä½¿ç”¨é è¨­è³‡æ–™');
                
                // 4. ä½¿ç”¨é è¨­è³‡æ–™ä½œç‚ºæœ€å¾Œå‚™æ¡ˆ
                if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                    log('ğŸ”„ åˆå§‹åŒ–é è¨­é¤è»Šè³‡æ–™...');
                }
                
                return { success: false, source: 'default', count: foodTruckDatabase.length, error: error.message };
            }
        }
        
        // æ¨¡æ“¬ validateData å‡½æ•¸
        function validateData() {
            log('ğŸ” é©—è­‰è³‡æ–™å®Œæ•´æ€§...');
            
            if (!foodTruckDatabase || !Array.isArray(foodTruckDatabase)) {
                log('âŒ foodTruckDatabase ä¸æ˜¯æœ‰æ•ˆé™£åˆ—');
                return false;
            }
            
            let validCount = 0;
            foodTruckDatabase.forEach((truck, index) => {
                if (truck && truck.id && truck.title && truck.src) {
                    validCount++;
                } else {
                    log(`âš ï¸ é¤è»Š ${index} è³‡æ–™ä¸å®Œæ•´:`, truck);
                }
            });
            
            log(`ğŸ“Š è³‡æ–™é©—è­‰çµæœ: ${validCount}/${foodTruckDatabase.length} å€‹æœ‰æ•ˆé¤è»Š`);
            return validCount > 0;
        }
        
        // æ¨¡æ“¬ repairData å‡½æ•¸
        function repairData() {
            log('ğŸ”§ é–‹å§‹ä¿®å¾©è³‡æ–™...');
            
            if (!foodTruckDatabase || !Array.isArray(foodTruckDatabase)) {
                log('ğŸ”§ ä¿®å¾© foodTruckDatabase é™£åˆ—');
                foodTruckDatabase = [];
            }
            
            foodTruckDatabase = foodTruckDatabase.filter(truck => {
                if (!truck || typeof truck !== 'object') return false;
                if (!truck.id || !truck.title || !truck.src) return false;
                return true;
            });
            
            foodTruckDatabase.forEach((truck, index) => {
                truck.priority = index + 1;
                if (!truck.isActive) truck.isActive = true;
                if (!truck.category) truck.category = 'main';
            });
            
            log(`ğŸ”§ è³‡æ–™ä¿®å¾©å®Œæˆ: ${foodTruckDatabase.length} å€‹æœ‰æ•ˆé¤è»Š`);
            return foodTruckDatabase.length;
        }
        
        // æ¨¡æ“¬ initializeData å‡½æ•¸
        function initializeData() {
            log('ğŸ”„ åˆå§‹åŒ–è³‡æ–™ç‹€æ…‹...');
            
            const isValid = validateData();
            
            if (!isValid) {
                log('ğŸ”§ è³‡æ–™ç„¡æ•ˆï¼Œé–‹å§‹ä¿®å¾©...');
                const repairedCount = repairData();
                log(`ğŸ”§ ä¿®å¾©å®Œæˆ: ${repairedCount} å€‹é¤è»Š`);
            }
            
            if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                log('âš ï¸ foodTruckDatabase ç‚ºç©ºï¼Œä½¿ç”¨é è¨­è³‡æ–™');
            }
            
            filteredTrucks = [...foodTruckDatabase];
            
            if (!selectedTrucks || !(selectedTrucks instanceof Set)) {
                selectedTrucks = new Set();
            }
            
            log(`âœ… è³‡æ–™åˆå§‹åŒ–å®Œæˆ: ${foodTruckDatabase.length} å€‹é¤è»Š`);
            
            return {
                foodTruckCount: foodTruckDatabase.length,
                filteredCount: filteredTrucks.length,
                hasData: foodTruckDatabase.length > 0,
                isValid: isValid
            };
        }
        
        // æ¸¬è©¦å‡½æ•¸
        async function testNormalLoad() {
            log('ğŸ§ª é–‹å§‹æ­£å¸¸è¼‰å…¥æ¸¬è©¦...');
            showStatus('æ­£åœ¨æ¸¬è©¦æ­£å¸¸è¼‰å…¥...', 'warning');
            
            try {
                const loadResult = await loadFoodTruckData();
                log(`ğŸ“Š è¼‰å…¥çµæœ: ${JSON.stringify(loadResult)}`);
                
                const initResult = initializeData();
                log(`ğŸ”§ åˆå§‹åŒ–çµæœ: ${JSON.stringify(initResult)}`);
                
                if (initResult.hasData) {
                    showStatus(`âœ… æ­£å¸¸è¼‰å…¥æˆåŠŸ: ${initResult.foodTruckCount} å€‹é¤è»Š`, 'success');
                } else {
                    showStatus('âš ï¸ æ­£å¸¸è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™', 'warning');
                }
            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
                showStatus(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testForceReload() {
            log('ğŸ§ª é–‹å§‹å¼·åˆ¶é‡æ–°è¼‰å…¥æ¸¬è©¦...');
            showStatus('æ­£åœ¨æ¸¬è©¦å¼·åˆ¶é‡æ–°è¼‰å…¥...', 'warning');
            
            try {
                localStorage.removeItem('foodTruckData');
                sessionStorage.removeItem('foodTruckData');
                log('ğŸ—‘ï¸ å·²æ¸…é™¤æœ¬åœ°å¿«å–');
                
                const loadResult = await loadFoodTruckData();
                log(`ğŸ“Š è¼‰å…¥çµæœ: ${JSON.stringify(loadResult)}`);
                
                const initResult = initializeData();
                log(`ğŸ”§ åˆå§‹åŒ–çµæœ: ${JSON.stringify(initResult)}`);
                
                if (initResult.hasData) {
                    showStatus(`âœ… å¼·åˆ¶é‡æ–°è¼‰å…¥æˆåŠŸ: ${initResult.foodTruckCount} å€‹é¤è»Š`, 'success');
                } else {
                    showStatus('âš ï¸ å¼·åˆ¶é‡æ–°è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™', 'warning');
                }
            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
                showStatus(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        function testCorruptedData() {
            log('ğŸ§ª é–‹å§‹æå£è³‡æ–™æ¸¬è©¦...');
            showStatus('æ­£åœ¨æ¸¬è©¦æå£è³‡æ–™è™•ç†...', 'warning');
            
            try {
                // æ¨¡æ“¬æå£çš„è³‡æ–™
                foodTruckDatabase = [
                    { id: 'truck_001', title: 'æ­£å¸¸é¤è»Š', src: 'https://example.com/image1.jpg' },
                    { id: 'truck_002', title: '', src: 'https://example.com/image2.jpg' }, // ç¼ºå°‘æ¨™é¡Œ
                    { id: '', title: 'é¤è»Š3', src: 'https://example.com/image3.jpg' }, // ç¼ºå°‘ID
                    null, // ç©ºå€¼
                    { title: 'é¤è»Š5', src: 'https://example.com/image5.jpg' }, // ç¼ºå°‘ID
                ];
                
                log('ğŸ’¥ è¨­å®šæå£çš„æ¸¬è©¦è³‡æ–™');
                
                const initResult = initializeData();
                log(`ğŸ”§ åˆå§‹åŒ–çµæœ: ${JSON.stringify(initResult)}`);
                
                if (initResult.hasData) {
                    showStatus(`âœ… æå£è³‡æ–™ä¿®å¾©æˆåŠŸ: ${initResult.foodTruckCount} å€‹æœ‰æ•ˆé¤è»Š`, 'success');
                } else {
                    showStatus('âš ï¸ æå£è³‡æ–™ä¿®å¾©å¤±æ•—', 'warning');
                }
            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
                showStatus(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        function clearAllData() {
            log('ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™...');
            localStorage.removeItem('foodTruckData');
            sessionStorage.removeItem('foodTruckData');
            foodTruckDatabase = [];
            filteredTrucks = [];
            selectedTrucks = new Set();
            showStatus('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ è³‡æ–™è¼‰å…¥æ¸¬è©¦é é¢å·²è¼‰å…¥');
            testNormalLoad();
        });
    </script>
</body>
</html>
