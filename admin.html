<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐車圖片管理後台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --success-color: #10b981;
            --success-dark: #059669;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
            --secondary-color: #64748b;
            --secondary-dark: #475569;
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-hover: #f1f5f9;
            --border: #e2e8f0;
            --border-hover: #cbd5e1;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* 智能容器佈局 */
        .admin-container {
            max-width: min(95vw, 1200px);
            margin: 0 auto;
            background: var(--surface);
            min-height: 100vh;
            box-shadow: var(--shadow-lg);
        }

        /* 響應式標題區 */
        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: clamp(1rem, 4vw, 2rem);
            position: relative;
            overflow: hidden;
        }

        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23pattern)"/></svg>');
            pointer-events: none;
        }

        .admin-header-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .admin-header h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .admin-header p {
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            opacity: 0.9;
            font-weight: 300;
        }

        /* 智能內容佈局 */
        .admin-content {
            padding: clamp(1rem, 3vw, 2rem);
            display: flex;
            flex-direction: column;
            gap: clamp(1rem, 2vw, 1.5rem);
        }

        /* 智能統計卡片網格 */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(150px, 100%), 1fr));
            gap: clamp(0.75rem, 2vw, 1.5rem);
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: clamp(0.75rem, 3vw, 1.5rem);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            aspect-ratio: 3/2;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-hover);
        }

        .stat-number {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: clamp(0.7rem, 2vw, 0.875rem);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* 智能搜尋區域 */
        .search-filter-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: clamp(0.75rem, 3vw, 1.5rem);
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-size: clamp(1rem, 3vw, 1.25rem);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* 智能搜尋網格 */
        .search-filter-row {
            display: grid;
            grid-template-columns: 
                minmax(0, 2fr) 
                minmax(min-content, 1fr) 
                minmax(min-content, 1fr) 
                min-content;
            gap: clamp(0.5rem, 2vw, 1rem);
            align-items: end;
        }

        @media (max-width: 768px) {
            .search-filter-row {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }

        .search-box {
            position: relative;
            min-width: 0;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: clamp(0.875rem, 2vw, 1rem);
            transition: all 0.3s ease;
            background: var(--surface);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: clamp(0.875rem, 2vw, 1rem);
            background: var(--surface);
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 智能按鈕系統 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: clamp(0.5rem, 2vw, 0.75rem) clamp(0.75rem, 3vw, 1.5rem);
            border: none;
            border-radius: 8px;
            font-size: clamp(0.75rem, 2vw, 0.875rem);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
            min-height: 44px; /* 觸控友好尺寸 */
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: var(--success-dark); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover { background: var(--danger-dark); }
        .btn-warning { background: var(--warning-color); color: white; }
        .btn-warning:hover { background: var(--warning-dark); }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-secondary:hover { background: var(--secondary-dark); }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            min-height: 36px;
        }

        /* 智能餐車網格 - 5欄緊湊版 */
        .truck-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(200px, 100%), 1fr));
            gap: clamp(0.5rem, 1.5vw, 1rem);
        }

        .truck-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .truck-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-hover);
        }

        .truck-card.active { border-color: var(--success-color); }
        .truck-card.inactive { border-color: var(--danger-color); opacity: 0.7; }
        .truck-card.selected { border-color: var(--primary-color); background: rgba(59, 130, 246, 0.05); }

        .truck-image-container {
            position: relative;
            height: clamp(80px, 15vw, 120px);
            overflow: hidden;
            background: var(--surface-hover);
        }

        .truck-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .truck-card:hover .truck-image {
            transform: scale(1.05);
        }

        .truck-priority-badge {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            z-index: 2;
        }

        .truck-checkbox {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 16px;
            height: 16px;
            z-index: 2;
            cursor: pointer;
        }

        .truck-info {
            padding: clamp(0.5rem, 2vw, 0.75rem);
        }

        .truck-title {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.3;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .truck-title:hover {
            color: var(--primary-color);
        }

        .truck-alt {
            font-size: clamp(0.65rem, 1.5vw, 0.75rem);
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            line-height: 1.2;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .truck-links {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .truck-link-btn {
            padding: 0.15rem 0.4rem;
            font-size: 0.65rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface-hover);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .truck-link-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .truck-actions {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .status-badge {
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .move-buttons {
            position: absolute;
            top: 50%;
            right: 0.5rem;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            z-index: 3;
        }

        .move-btn {
            width: 18px;
            height: 18px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            line-height: 1;
            border: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .move-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        /* 內聯編輯樣式 */
        .truck-card.editing {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.05);
        }

        .truck-card.editing .truck-title-input,
        .truck-card.editing .truck-alt-input,
        .truck-card.editing .truck-link-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: inherit;
            background: var(--surface);
            margin-bottom: 0.25rem;
            user-select: text;
        }

        .truck-card.editing .truck-title-input {
            font-weight: 600;
            font-size: clamp(0.75rem, 2vw, 0.9rem);
        }

        .truck-card.editing .truck-alt-input {
            font-size: clamp(0.65rem, 1.5vw, 0.75rem);
            height: 60px;
            resize: vertical;
        }

        .truck-card.editing .truck-link-input {
            font-size: 0.65rem;
            margin-bottom: 0.15rem;
        }

        .truck-card.editing .edit-links-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .truck-card.editing .edit-link-group {
            display: contents;
        }

        .truck-card.editing .edit-link-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-bottom: 0.1rem;
        }

        /* 緊湊按鈕樣式 */
        .truck-actions .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.65rem;
            min-height: 24px;
            border-radius: 6px;
        }

        /* 響應式調整 */
        @media (max-width: 480px) {
            .truck-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .truck-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .truck-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.75rem;
            }
        }

        @media (min-width: 1025px) {
            .truck-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 1rem;
            }
        }

        /* 智能表單佈局 */
        .form-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: clamp(1rem, 3vw, 1.5rem);
            box-shadow: var(--shadow-sm);
        }

        .form-section-title {
            font-size: clamp(1rem, 3vw, 1.125rem);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section-description {
            font-size: clamp(0.8rem, 2vw, 0.875rem);
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        /* 智能表單網格 */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(240px, 100%), 1fr));
            gap: clamp(0.75rem, 2vw, 1rem);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: clamp(0.8rem, 2vw, 0.875rem);
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .label-icon {
            font-size: 0.75rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: clamp(0.875rem, 2vw, 1rem);
            transition: all 0.3s ease;
            background: var(--surface);
            min-height: 44px; /* 觸控友好 */
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-hint {
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            color: var(--text-light);
            margin-top: 0.25rem;
            font-style: italic;
        }

        /* 智能範例區域 */
        .examples-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 12px;
            padding: clamp(1rem, 3vw, 1.25rem);
            margin-bottom: 1.5rem;
        }

        .examples-title {
            font-size: clamp(0.9rem, 2vw, 1rem);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .examples-title::before {
            content: "💡";
            font-size: 1rem;
        }

        /* 智能範例網格 */
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(120px, 100%), 1fr));
            gap: clamp(0.5rem, 2vw, 0.75rem);
        }

        .example-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: clamp(0.5rem, 2vw, 0.75rem);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .example-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .example-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .example-item:hover::before {
            transform: scaleX(1);
        }

        .example-label {
            display: block;
            font-size: clamp(0.75rem, 2vw, 0.875rem);
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .example-url {
            display: block;
            font-size: clamp(0.65rem, 1.5vw, 0.75rem);
            color: var(--text-secondary);
            line-height: 1.3;
        }

        /* 3欄連結佈局 */
        .links-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(0.75rem, 2vw, 1.5rem);
            margin-bottom: 1rem;
        }

        .link-column {
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: clamp(0.75rem, 2vw, 1rem);
            transition: all 0.3s ease;
        }

        .link-column:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-sm);
        }

        .link-column .link-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .link-column .link-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .link-column .link-title {
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            font-weight: 600;
            color: var(--text-primary);
        }

        .link-column .form-group {
            margin-bottom: 0.75rem;
        }

        .link-column .form-input {
            padding: 0.5rem 0.75rem;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            min-height: 36px;
        }

        .link-column .form-label {
            font-size: clamp(0.75rem, 1.5vw, 0.8rem);
            margin-bottom: 0.3rem;
        }

        .link-column .input-hint {
            font-size: clamp(0.65rem, 1.5vw, 0.7rem);
            margin-top: 0.15rem;
        }

        /* 手機版改為垂直排列 */
        @media (max-width: 768px) {
            .links-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* 平板版改為2欄 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .links-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .link-column:nth-child(3) {
                grid-column: 1 / -1;
                max-width: 50%;
                margin: 0 auto;
            }
        }

        /* 智能批量操作 */
        .batch-actions {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: clamp(0.75rem, 3vw, 1rem);
            display: none;
        }

        .batch-actions.show {
            display: block;
        }

        .batch-actions-content {
            display: flex;
            gap: clamp(0.5rem, 2vw, 1rem);
            align-items: center;
            flex-wrap: wrap;
        }

        .batch-count {
            font-weight: 600;
            color: var(--primary-color);
            font-size: clamp(0.85rem, 2vw, 1rem);
        }

        /* 智能預覽區域 */
        .preview-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: clamp(1rem, 3vw, 1.5rem);
            box-shadow: var(--shadow-sm);
        }

        .marquee-preview {
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: clamp(0.75rem, 2vw, 1rem);
            overflow: hidden;
            margin-top: 1rem;
        }

        .marquee-track-preview {
            display: flex;
            gap: 1rem;
            animation: marquee-scroll 20s linear infinite;
        }

        .marquee-item-preview {
            flex-shrink: 0;
            width: clamp(60px, 10vw, 80px);
            height: clamp(45px, 7.5vw, 60px);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .marquee-item-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes marquee-scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* 智能模態框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: clamp(1rem, 5vw, 2rem);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            position: relative;
            max-width: min(90vw, 800px);
            max-height: 90vh;
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: modalFadeIn 0.3s ease;
        }

        .modal-content img {
            width: 100%;
            height: auto;
            max-height: 80vh;
            object-fit: contain;
            display: block;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* 智能通知系統 */
        .alert {
            padding: clamp(0.75rem, 2vw, 1rem);
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            font-weight: 500;
            border: 1px solid;
            font-size: clamp(0.85rem, 2vw, 1rem);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .sync-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            font-weight: 500;
            font-size: clamp(0.85rem, 2vw, 1rem);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .example-item.clicked {
            animation: clickAnimation 0.3s ease;
        }

        @keyframes clickAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* 容器查詢支援 */
        @container (max-width: 600px) {
            .truck-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
        }

        /* 高對比度模式支援 */
        @media (prefers-contrast: high) {
            :root {
                --border: #000000;
                --text-secondary: #000000;
            }
        }

        /* 減少動畫偏好 */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* 深色模式支援 */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0f172a;
                --surface: #1e293b;
                --surface-hover: #334155;
                --border: #475569;
                --border-hover: #64748b;
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --text-light: #94a3b8;
            }
        }

        /* 專為行動裝置優化 */
        @media (max-width: 480px) {
            .admin-container {
                margin: 0;
                border-radius: 0;
            }
            
            .truck-grid {
                grid-template-columns: 1fr;
            }
            
            .search-filter-row {
                grid-template-columns: 1fr;
            }
            
            .batch-actions-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .examples-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 平板橫向優化 */
        @media (min-width: 768px) and (max-width: 1024px) {
            .truck-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 大螢幕優化 */
        @media (min-width: 1400px) {
            .admin-container {
                max-width: 1400px;
            }
            
            .truck-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        /* 印刷樣式 */
        @media print {
            .admin-header,
            .batch-actions,
            .btn,
            .move-buttons,
            .sync-status {
                display: none !important;
            }
            
            .truck-card {
                break-inside: avoid;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-header-content">
                <h1>🍽️ 餐車圖片管理後台</h1>
                <p>智能化管理跑馬燈中的餐車圖片</p>
            </div>
        </div>

        <div class="admin-content">
            <div id="alertMessage" class="alert"></div>
            
            <div id="syncStatus" class="sync-status" style="display: none;">
                <span id="syncMessage">🔄 資料已同步到前端</span>
            </div>

            <div class="search-filter-section">
                <h3 class="section-title">🔍 搜尋與篩選</h3>
                <div class="search-filter-row">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="搜尋餐車名稱..." class="form-input">
                        <span class="search-icon">🔍</span>
                    </div>
                    <select id="statusFilter" class="filter-select">
                        <option value="all">全部狀態</option>
                        <option value="active">已上架</option>
                        <option value="inactive">已下架</option>
                    </select>
                    <select id="sortBy" class="filter-select">
                        <option value="priority">按優先級</option>
                        <option value="title">按名稱</option>
                        <option value="id">按ID</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearFilters()">清除篩選</button>
                </div>
            </div>

            <div id="batchActions" class="batch-actions">
                <div class="batch-actions-content">
                    <span class="batch-count">已選擇 <span id="selectedCount">0</span> 個餐車</span>
                    <button class="btn btn-success btn-sm" onclick="batchToggle(true)">批量上架</button>
                    <button class="btn btn-danger btn-sm" onclick="batchToggle(false)">批量下架</button>
                    <button class="btn btn-warning btn-sm" onclick="batchDelete()">批量刪除</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearSelection()">取消選擇</button>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">➕ 新增餐車</h3>
                <form id="addTruckForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newTruckTitle" class="form-label">餐車名稱</label>
                            <input type="text" id="newTruckTitle" class="form-input" placeholder="例如：酥炸大熱狗" required>
                        </div>
                        <div class="form-group">
                            <label for="newTruckSrc" class="form-label">跑馬燈顯示圖片網址</label>
                            <input type="url" id="newTruckSrc" class="form-input" placeholder="https://example.com/image.jpg" required>
                        </div>
                        <div class="form-group">
                            <label for="newTruckAlt" class="form-label">替代文字</label>
                            <input type="text" id="newTruckAlt" class="form-input" placeholder="圖片描述文字">
                        </div>
                        <div class="form-group">
                            <label for="newTruckImgLink" class="form-label">圖片超連結</label>
                            <input type="url" id="newTruckImgLink" class="form-input" placeholder="https://example.com (選填)">
                        </div>
                    </div>
                    

                    <div style="margin-top: 2rem;">
                        <h4 class="form-section-title">🔗 超連結設定</h4>
                        <p class="form-section-description">為餐車添加最多 3 個社群媒體或官網連結</p>
                        
                        <div class="examples-section">
                            <h5 class="examples-title">常見範例：</h5>
                            <div class="examples-grid">
                                <div class="example-item" onclick="fillExample('官網', 'https://www.example-restaurant.com')">
                                    <span class="example-label">官網</span>
                                    <span class="example-url">官方網站</span>
                                </div>
                                <div class="example-item" onclick="fillExample('FB', 'https://www.facebook.com/restaurantpage')">
                                    <span class="example-label">FB</span>
                                    <span class="example-url">Facebook 粉絲頁</span>
                                </div>
                                <div class="example-item" onclick="fillExample('IG', 'https://www.instagram.com/restaurant_account')">
                                    <span class="example-label">IG</span>
                                    <span class="example-url">Instagram 帳號</span>
                                </div>
                                <div class="example-item" onclick="fillExample('菜單', 'https://www.foodpanda.com.tw/restaurant/menu')">
                                    <span class="example-label">菜單</span>
                                    <span class="example-url">線上菜單</span>
                                </div>
                                <div class="example-item" onclick="fillExample('訂餐', 'https://line.me/R/ti/p/@restaurant')">
                                    <span class="example-label">訂餐</span>
                                    <span class="example-url">LINE 官方帳號</span>
                                </div>
                                <div class="example-item" onclick="fillExample('地圖', 'https://goo.gl/maps/restaurant-location')">
                                    <span class="example-label">地圖</span>
                                    <span class="example-url">Google 地圖</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 3欄連結佈局 -->
                        <div class="links-container">
                            <div class="link-column">
                                <div class="link-header">
                                    <span class="link-number">1</span>
                                    <span class="link-title">第一個連結</span>
                                </div>
                                <div class="form-group">
                                    <label for="newTruckText1" class="form-label">
                                        <span class="label-icon">🏷️</span>
                                        按鈕文字
                                    </label>
                                    <input type="text" id="newTruckText1" class="form-input" placeholder="官網" maxlength="10">
                                    <div class="input-hint">最多 10 個字</div>
                                </div>
                                <div class="form-group">
                                    <label for="newTruckLink1" class="form-label">
                                        <span class="label-icon">🌐</span>
                                        網址
                                    </label>
                                    <input type="url" id="newTruckLink1" class="form-input" placeholder="https://example.com">
                                    <div class="input-hint">選填</div>
                                </div>
                            </div>

                            <div class="link-column">
                                <div class="link-header">
                                    <span class="link-number">2</span>
                                    <span class="link-title">第二個連結</span>
                                </div>
                                <div class="form-group">
                                    <label for="newTruckText2" class="form-label">
                                        <span class="label-icon">🏷️</span>
                                        按鈕文字
                                    </label>
                                    <input type="text" id="newTruckText2" class="form-input" placeholder="FB" maxlength="10">
                                    <div class="input-hint">最多 10 個字</div>
                                </div>
                                <div class="form-group">
                                    <label for="newTruckLink2" class="form-label">
                                        <span class="label-icon">🌐</span>
                                        網址
                                    </label>
                                    <input type="url" id="newTruckLink2" class="form-input" placeholder="https://facebook.com">
                                    <div class="input-hint">選填</div>
                                </div>
                            </div>

                            <div class="link-column">
                                <div class="link-header">
                                    <span class="link-number">3</span>
                                    <span class="link-title">第三個連結</span>
                                </div>
                                <div class="form-group">
                                    <label for="newTruckText3" class="form-label">
                                        <span class="label-icon">🏷️</span>
                                        按鈕文字
                                    </label>
                                    <input type="text" id="newTruckText3" class="form-input" placeholder="IG" maxlength="10">
                                    <div class="input-hint">最多 10 個字</div>
                                </div>
                                <div class="form-group">
                                    <label for="newTruckLink3" class="form-label">
                                        <span class="label-icon">🌐</span>
                                        網址
                                    </label>
                                    <input type="url" id="newTruckLink3" class="form-input" placeholder="https://instagram.com">
                                    <div class="input-hint">選填</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 資料管理區塊 -->
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; justify-content: space-between;">
                            <div>
                                <h4 class="form-section-title" style="margin-bottom: 0;">💾 資料管理</h4>
                            </div>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button type="submit" class="btn btn-primary">➕ 新增餐車</button>
                                <button type="button" class="btn btn-secondary" onclick="openPostimageUpload()">🖼️ 開啟 Postimage</button>
                                <button type="button" class="btn btn-success" onclick="manualSaveData()">💾 儲存並同步</button>
                                <button type="button" class="btn btn-warning" onclick="checkForUpdates()">🔄 檢查更新</button>
                                <button type="button" class="btn btn-secondary" onclick="setupGitHubToken()" style="display: none;">🔑 設定 Token</button>
                                <button type="button" class="btn btn-info" onclick="openTokenSetup()" style="display: none;">🔧 開啟 Token 設定頁</button>
                                <button type="button" class="btn btn-secondary" onclick="debugDataStatus()" style="display: none;">🔍 檢查狀態</button>
                                <button type="button" class="btn btn-warning" onclick="forceReloadData()" style="display: none;">🔄 強制重新載入</button>
                                <button type="button" class="btn btn-danger" onclick="clearLocalData()" style="display: none;">🗑️ 清除本地資料</button>
                                <button type="button" class="btn btn-info" onclick="testDataJsonLoad()" style="display: none;">🧪 測試 data.json 載入</button>
                                <button type="button" class="btn btn-secondary" onclick="saveFoodTruckData()">📥 匯出資料</button>
                                <button type="button" class="btn btn-info" onclick="testSyncFunction()">🧪 測試同步</button>
                                <button type="button" class="btn btn-secondary" onclick="location.reload()">🔄 重新載入</button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>✅ 自動儲存：</strong>所有編輯操作都會自動儲存並同步到遠端（如果已設定 Token）
                        </div>
                    </div>
                </form>
            </div>

            <div class="truck-grid" id="truckGrid">
                <!-- 餐車卡片將由JavaScript動態生成 -->
            </div>

            <div class="preview-section">
                <h3 class="section-title">🎬 跑馬燈預覽</h3>
                <div class="marquee-preview">
                    <div class="marquee-track-preview" id="marqueePreview">
                        <!-- 預覽圖片將由JavaScript動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="hideImageModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="hideImageModal()">&times;</button>
            <img id="modalImage" src="" alt="">
        </div>
    </div>

    <!-- 載入其他模組 -->
    <script src="backup_current/auto-setup-token.js"></script>
    <script src="backup_current/update-checker.js"></script>
    
    <script>
        // 內建專案設定功能
        const SimpleProjectConfig = {
            // 載入專案設定
            load() {
                try {
                    const config = localStorage.getItem('projectConfig');
                    if (config) {
                        return JSON.parse(config);
                    }
                    
                    // 預設設定
                    return {
                        currentProject: {
                            name: "餐開月行程表",
                            username: "sky770825",
                            email: "sky19880825@gmail.com",
                            repository: "https://github.com/sky770825/niceshow.git",
                            website: "https://sky770825.github.io/niceshow",
                            isDefault: true
                        },
                        syncSettings: {
                            autoCheckUpdates: true,
                            checkInterval: 5 * 60 * 1000,
                            enableNotifications: true
                        },
                        lastUpdated: new Date().toISOString()
                    };
                } catch (error) {
                    console.error('載入專案設定失敗:', error);
                    return null;
                }
            },
            
            // 儲存專案設定
            save(config) {
                try {
                    config.lastUpdated = new Date().toISOString();
                    localStorage.setItem('projectConfig', JSON.stringify(config));
                    return true;
                } catch (error) {
                    console.error('儲存專案設定失敗:', error);
                    return false;
                }
            },
            
            // 取得 GitHub Token
            getGitHubToken() {
                try {
                    return localStorage.getItem('githubToken');
                } catch (error) {
                    console.error('取得 GitHub Token 失敗:', error);
                    return null;
                }
            },
            
            // 設定 GitHub Token
            setGitHubToken(token) {
                try {
                    if (token && token.trim()) {
                        localStorage.setItem('githubToken', token.trim());
                        console.log('✅ GitHub Token 已儲存');
                    } else {
                        localStorage.removeItem('githubToken');
                        console.log('🗑️ GitHub Token 已清除');
                    }
                    return true;
                } catch (error) {
                    console.error('儲存 GitHub Token 失敗:', error);
                    return false;
                }
            },
            
            // 取得當前專案資訊
            getCurrentProject() {
                try {
                    const config = this.load();
                    return config ? config.currentProject : null;
                } catch (error) {
                    console.error('取得當前專案失敗:', error);
                    return null;
                }
            },
            
            // 初始化專案設定
            initialize() {
                try {
                    const config = this.load();
                    if (config) {
                        console.log('✅ 專案設定已載入:', config.currentProject.name);
                        return config;
                    }
                    return null;
                } catch (error) {
                    console.error('初始化專案設定失敗:', error);
                    return null;
                }
            }
        };

        // 簡化版 GitHub 同步功能
        const SimpleGitHubSync = {
            currentProject: {
                name: "餐開月行程表",
                username: "sky770825",
                repository: "https://github.com/sky770825/niceshow.git",
                website: "https://sky770825.github.io/niceshow"
            },
            
            getProjectStatus() {
                const token = SimpleProjectConfig?.getGitHubToken();
                return {
                    hasToken: !!token,
                    hasProject: !!this.currentProject,
                    projectName: this.currentProject?.name || '未設定',
                    repository: this.currentProject?.repository || '未設定'
                };
            },
            
            async validateToken() {
                try {
                    const token = SimpleProjectConfig?.getGitHubToken();
                    
                    if (!token) {
                        return {
                            valid: false,
                            message: '未設定 GitHub Token'
                        };
                    }

                    const response = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const user = await response.json();
                        return {
                            valid: true,
                            message: `Token 有效，使用者: ${user.login}`,
                            user: user
                        };
                    } else {
                        return {
                            valid: false,
                            message: `Token 無效: ${response.status} ${response.statusText}`
                        };
                    }

                } catch (error) {
                    return {
                        valid: false,
                        message: `驗證失敗: ${error.message}`
                    };
                }
            },
            
            async syncData(data) {
                try {
                    const token = SimpleProjectConfig?.getGitHubToken();
                    if (!token) {
                        throw new Error('未設定 GitHub Token');
                    }

                    // 取得倉庫資訊
                    const repoInfo = this.parseRepositoryUrl(this.currentProject.repository);
                    if (!repoInfo) {
                        throw new Error('無效的倉庫 URL');
                    }

                    // 取得當前檔案內容
                    const fileResponse = await fetch(
                        `https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/contents/data.json`,
                        {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    let sha = null;
                    if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        sha = fileData.sha;
                    }

                    // 準備上傳資料
                    const content = JSON.stringify(data, null, 2);
                    const encodedContent = btoa(unescape(encodeURIComponent(content)));

                    const uploadData = {
                        message: '自動同步餐車資料',
                        content: encodedContent,
                        branch: 'main'
                    };

                    if (sha) {
                        uploadData.sha = sha;
                    }

                    // 上傳到 GitHub
                    const uploadResponse = await fetch(
                        `https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/contents/data.json`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(uploadData)
                        }
                    );

                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json();
                        throw new Error(`上傳失敗: ${uploadResponse.status} ${errorData.message || uploadResponse.statusText}`);
                    }

                    const result = await uploadResponse.json();
                    
                    return {
                        success: true,
                        commitUrl: result.commit.html_url,
                        commitMessage: result.commit.message,
                        commitSha: result.commit.sha
                    };

                } catch (error) {
                    console.error('同步失敗:', error);
                    throw error;
                }
            },
            
            parseRepositoryUrl(url) {
                try {
                    const patterns = [
                        /github\.com\/([^\/]+)\/([^\/]+?)(?:\.git)?$/,
                        /github\.com\/([^\/]+)\/([^\/]+?)(?:\/)?$/
                    ];
                    
                    for (const pattern of patterns) {
                        const match = url.match(pattern);
                        if (match) {
                            return {
                                owner: match[1],
                                repo: match[2]
                            };
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('解析倉庫 URL 失敗:', error);
                    return null;
                }
            }
        };

        // 餐車資料庫（從 data.json 載入）
        let foodTruckDatabase = [];
        let filteredTrucks = [];
        let selectedTrucks = new Set();

        // 載入策略管理器
        const LoadStrategy = {
            // 智能載入策略（強制從 data.json 載入）
            async smartLoad() {
                console.log('🧠 智能載入：強制從 data.json 載入...');
                
                // 1. 強制從遠端載入 data.json
                try {
                    const remoteData = await DataManager.loadFromRemote();
                    console.log('✅ 從 data.json 載入成功');
                    return this.applyRemoteData(remoteData);
                } catch (error) {
                    console.log('⚠️ 從 data.json 載入失敗:', error.message);
                    
                    // 2. 遠端載入失敗，嘗試從本地載入
                    const localData = DataManager.loadFromLocal();
                    if (localData) {
                        console.log('✅ 使用本地資料（備用）');
                        return this.applyLocalData(localData);
                    }
                    
                    // 3. 都失敗了，使用空狀態
                    console.log('⚠️ 沒有找到任何資料，使用空狀態');
                    return this.applyDefaultData();
                }
            },
            
            // 強制遠端載入策略
            async forceRemote() {
                console.log('🌐 強制從遠端載入資料...');
                
                try {
                    const remoteData = await DataManager.loadFromRemote();
                    return this.applyRemoteData(remoteData);
                    } catch (error) {
                    console.log('⚠️ 強制遠端載入失敗，使用預設資料');
                    return this.applyDefaultData();
                }
            },
            
            // 應用本地資料（強制覆蓋）
            applyLocalData(data) {
                console.log('🔄 強制應用本地資料到 foodTruckDatabase...');
                console.log(`   本地資料包含 ${data.foodTrucks.length} 個餐車`);
                
                // 強制覆蓋 foodTruckDatabase
                foodTruckDatabase = [...data.foodTrucks];
                
                // 檢查是否有編輯中的餐車
                const editingCount = foodTruckDatabase.filter(truck => truck.isEditing).length;
                if (editingCount > 0) {
                    console.log(`   ⚠️ 發現 ${editingCount} 個餐車正在編輯中`);
                }
                
                console.log(`✅ 本地資料已強制應用到 foodTruckDatabase`);
                return { 
                    success: true, 
                    source: 'localStorage', 
                    count: foodTruckDatabase.length,
                    data: data
                };
            },
            
            // 應用遠端資料
            applyRemoteData(data) {
                console.log('🔄 應用遠端資料到 foodTruckDatabase...');
                console.log(`   遠端資料包含 ${data.foodTrucks.length} 個餐車`);
                
                // 直接覆蓋 foodTruckDatabase
                foodTruckDatabase = [...data.foodTrucks];
                
                // 更新 filteredTrucks
                filteredTrucks = [...foodTruckDatabase];
                
                // 儲存到本地作為備份
                DataManager.saveToLocal();
                console.log('💾 遠端資料已儲存到本地');
                
                // 立即渲染餐車卡片
                console.log('🎨 立即渲染餐車卡片...');
                renderTruckCards();
                updateStats();
                
                return { 
                    success: true, 
                    source: 'remote', 
                    count: foodTruckDatabase.length,
                    data: data
                };
            },
            
            // 應用預設資料（空狀態）
            applyDefaultData() {
                // 保持空陣列，不載入任何預設資料
                console.log('⚠️ 沒有找到任何資料，使用空狀態');
                return { 
                    success: false, 
                    source: 'empty', 
                    count: 0,
                    data: null
                };
            }
        };
        
        // 主要的資料載入函數
        async function loadFoodTruckData(forceRemote = false) {
            console.log('🔄 開始載入餐車資料...');
            
            try {
                if (forceRemote) {
                    return await LoadStrategy.forceRemote();
                } else {
                    return await LoadStrategy.smartLoad();
                }
            } catch (error) {
                console.error('❌ 載入餐車資料失敗:', error);
                return LoadStrategy.applyDefaultData();
            }
        }
        
        // ==================== 編輯管理模組 ====================
        
        const EditManager = {
            // 開始編輯
            startEdit(truckId) {
                const truck = foodTruckDatabase.find(t => t.id === truckId);
                if (truck) {
                    truck.isEditing = true;
                    this.saveState();
                    console.log(`✏️ 開始編輯餐車: ${truck.title}`);
                    return true;
                }
                return false;
            },
            
            // 保存編輯
            async saveEdit(truckId) {
                const truck = foodTruckDatabase.find(t => t.id === truckId);
                if (!truck) return false;
                
                // 獲取編輯後的值
                const newTitle = document.getElementById(`edit-title-${truckId}`)?.value.trim();
                const newAlt = document.getElementById(`edit-alt-${truckId}`)?.value.trim();
                
                if (!newTitle) {
                    alert('餐車名稱不能為空！');
                    return false;
                }
                
                // 更新基本資訊
                truck.title = newTitle;
                truck.alt = newAlt || newTitle;
                
                // 更新連結
                const linkData = [];
                for (let i = 1; i <= 3; i++) {
                    const textInput = document.getElementById(`edit-text-${truckId}-${i}`);
                    const urlInput = document.getElementById(`edit-url-${truckId}-${i}`);
                    
                    if (textInput && urlInput) {
                        const text = textInput.value.trim();
                        const url = urlInput.value.trim();
                        
                        if (text && url) {
                            linkData.push({ text, url });
                        }
                    }
                }
                
                truck.link = linkData.length > 0 ? linkData : '';
                truck.isEditing = false;
                
                // 保存狀態
                this.saveState();
                
                console.log(`💾 餐車 "${truck.title}" 編輯已保存`);
                return true;
            },
            
            // 取消編輯
            cancelEdit(truckId) {
                const truck = foodTruckDatabase.find(t => t.id === truckId);
                if (truck) {
                    truck.isEditing = false;
                    this.saveState();
                    console.log(`❌ 取消編輯餐車: ${truck.title}`);
                    return true;
                }
                return false;
            },
            
            // 保存編輯狀態到本地
            saveState() {
                console.log('💾 保存編輯狀態...');
                DataManager.saveToLocal();
                console.log('✅ 編輯狀態已保存');
            },
            
            // 檢查是否有餐車正在編輯
            hasEditingTruck() {
                return foodTruckDatabase && foodTruckDatabase.some(truck => truck.isEditing);
            },
            
            // 獲取正在編輯的餐車
            getEditingTrucks() {
                return foodTruckDatabase ? foodTruckDatabase.filter(truck => truck.isEditing) : [];
            }
        };

        // 獨立的資料驗證函數
        function validateData() {
            console.log('🔍 驗證資料完整性...');
            
            // 檢查 foodTruckDatabase
            if (!foodTruckDatabase || !Array.isArray(foodTruckDatabase)) {
                console.log('❌ foodTruckDatabase 不是有效陣列');
                return false;
            }
            
            // 檢查每個餐車資料
            let validCount = 0;
            foodTruckDatabase.forEach((truck, index) => {
                if (truck && truck.id && truck.title && truck.src) {
                    validCount++;
                } else {
                    console.log(`⚠️ 餐車 ${index} 資料不完整:`, truck);
                    console.log(`   - ID: ${truck?.id || '缺少'}`);
                    console.log(`   - Title: ${truck?.title || '缺少'}`);
                    console.log(`   - Src: ${truck?.src || '缺少'}`);
                    console.log(`   - 編輯狀態: ${truck?.isEditing || false}`);
                }
            });
            
            console.log(`📊 資料驗證結果: ${validCount}/${foodTruckDatabase.length} 個有效餐車`);
            return validCount > 0;
        }

        // ==================== 資料管理模組 ====================
            
        // 資料管理器 - 負責所有資料操作
        const DataManager = {
            // 儲存資料到本地
            saveToLocal() {
            const data = {
                foodTrucks: foodTruckDatabase,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0',
                    syncCount: this.getSyncCount()
            };
            
            localStorage.setItem('foodTruckData', JSON.stringify(data));
            sessionStorage.setItem('foodTruckData', JSON.stringify(data));
            
                console.log('💾 資料已儲存到本地儲存');
                return data;
            },
            
            // 從本地載入資料（更積極的載入策略）
            loadFromLocal() {
                console.log('📱 檢查本地儲存資料...');
                const localData = localStorage.getItem('foodTruckData');
                
                if (!localData) {
                    console.log('📱 localStorage 中沒有 foodTruckData');
                    return null;
                }
                
                try {
                    const data = JSON.parse(localData);
                    console.log('📱 成功解析本地資料');
                    
                    if (data && data.foodTrucks && Array.isArray(data.foodTrucks) && data.foodTrucks.length > 0) {
                        console.log(`📱 本地資料包含 ${data.foodTrucks.length} 個餐車`);
                        console.log(`📱 最後更新時間: ${data.lastUpdated}`);
                        
                        // 檢查是否有編輯中的餐車
                        const editingCount = data.foodTrucks.filter(truck => truck.isEditing).length;
                        if (editingCount > 0) {
                            console.log(`📱 ⚠️ 發現 ${editingCount} 個餐車正在編輯中，優先使用本地資料`);
                        }
                        
                        return data;
                    } else {
                        console.log('📱 本地資料格式不正確或為空');
                        return null;
                    }
                } catch (error) {
                    console.error('❌ 解析本地資料失敗:', error);
                    return null;
                }
            },
            
            // 從遠端載入資料
            async loadFromRemote() {
                try {
                    const response = await fetch('data.json?' + Date.now());
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    if (data && data.foodTrucks && Array.isArray(data.foodTrucks)) {
                        console.log('🌐 從遠端載入資料成功');
                        return data;
                    }
                    throw new Error('遠端資料格式不正確');
                } catch (error) {
                    console.error('❌ 從遠端載入資料失敗:', error);
                    throw error;
                }
            },
            
            // 獲取同步計數
            getSyncCount() {
                try {
                    const existingData = localStorage.getItem('foodTruckData');
                    if (existingData) {
                        const parsed = JSON.parse(existingData);
                        return parsed.syncCount || 0;
                    }
                } catch (error) {
                    console.warn('⚠️ 獲取同步計數失敗:', error);
                }
                return 0;
            },
            
            // 更新同步計數
            incrementSyncCount() {
                const currentCount = this.getSyncCount();
                const newCount = currentCount + 1;
                console.log(`📊 同步計數: ${currentCount} → ${newCount}`);
                return newCount;
            }
        };
        
        // 統一的本地儲存函數（向後兼容）
        function saveDataToLocal() {
            return DataManager.saveToLocal();
        }

        // 編輯狀態管理函數（向後兼容）
        function saveEditingState() {
            EditManager.saveState();
        }

        // 獨立的資料修復函數
        function repairData() {
            console.log('🔧 開始修復資料...');
            
            // 1. 修復 foodTruckDatabase
            if (!foodTruckDatabase || !Array.isArray(foodTruckDatabase)) {
                console.log('🔧 修復 foodTruckDatabase 陣列');
                foodTruckDatabase = [];
            }
            
            // 2. 修復每個餐車資料
            foodTruckDatabase = foodTruckDatabase.filter(truck => {
                if (!truck || typeof truck !== 'object') return false;
                if (!truck.id || !truck.title || !truck.src) return false;
                return true;
            });
            
            // 3. 重新設定優先級和預設值（保留編輯狀態）
            foodTruckDatabase.forEach((truck, index) => {
                truck.priority = index + 1;
                if (truck.isActive === undefined) truck.isActive = true;
                if (!truck.category) truck.category = 'main';
                // 重要：保留編輯狀態，絕對不要重置！
                // truck.isEditing 保持原值，不進行任何修改
                console.log(`🔧 修復餐車 ${index}: ${truck.title}, 編輯狀態: ${truck.isEditing}`);
            });
            
            console.log(`🔧 資料修復完成: ${foodTruckDatabase.length} 個有效餐車`);
            return foodTruckDatabase.length;
        }

        // 獨立的初始化函數
        function initializeData() {
            console.log('🔄 初始化資料狀態...');
            
            // 1. 驗證資料完整性
            const isValid = validateData();
            
            // 2. 如果資料無效，嘗試修復
            if (!isValid) {
                console.log('🔧 資料無效，開始修復...');
                const repairedCount = repairData();
                console.log(`🔧 修復完成: ${repairedCount} 個餐車`);
            }
            
            // 3. 確保 foodTruckDatabase 有資料
            if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                console.log('⚠️ foodTruckDatabase 為空，保持空狀態');
                // 保持空陣列，不載入預設資料
            }
            
            // 4. 初始化 filteredTrucks
            filteredTrucks = [...foodTruckDatabase];
            
            // 5. 確保 selectedTrucks 是有效的 Set
            if (!selectedTrucks || !(selectedTrucks instanceof Set)) {
                selectedTrucks = new Set();
            }
            
            console.log(`✅ 資料初始化完成: ${foodTruckDatabase.length} 個餐車`);
            
            return {
                foodTruckCount: foodTruckDatabase.length,
                filteredCount: filteredTrucks.length,
                hasData: foodTruckDatabase.length > 0,
                isValid: isValid
            };
        }

        let isSaving = false;
        let lastSaveTime = 0;
        
        // ==================== 同步管理模組 ====================
        
        const SyncManager = {
            // 手動儲存並同步
            async manualSave() {
            const now = Date.now();
            
            if (isSaving || now - lastSaveTime < 300) {
                console.log('⚠️ 跳過重複儲存');
                return;
            }
            
            isSaving = true;
            lastSaveTime = now;
            
                // 1. 儲存到本地
                const data = DataManager.saveToLocal();
                
                // 2. 增加同步計數
                data.syncCount = DataManager.incrementSyncCount();
            localStorage.setItem('foodTruckData', JSON.stringify(data));
            sessionStorage.setItem('foodTruckData', JSON.stringify(data));
            
            console.log('💾 資料已儲存到本地');
            
            try {
                    // 3. 檢查 GitHub 設定
                const status = SimpleGitHubSync.getProjectStatus();
                
                if (!status.hasToken) {
                        // 靜默處理，不顯示 Token 設定提醒
                        showSyncStatus('❌ 未設定 Token，僅儲存到本地');
                    } else {
                    await validateAndSync(data);
                }
            } catch (error) {
                    console.error('同步失敗:', error);
                    showSyncStatus('❌ 同步失敗，但已儲存到本地');
                    // 移除自動下載檔案功能
                }
                
                setTimeout(() => {
                    isSaving = false;
                }, 300);
            },
            
            // 處理 Token 設定（靜默模式，不顯示提醒）
            async handleTokenSetup(data) {
                try {
                    // 直接嘗試同步，不顯示確認對話框
                    await validateAndSync(data);
                } catch (error) {
                    // 如果同步失敗，僅儲存到本地，不顯示錯誤提醒
                    console.log('⚠️ 同步失敗，僅儲存到本地:', error.message);
                    showSyncStatus('💾 已儲存到本地（未同步到遠端）');
                }
            }
        };
        
        // 手動儲存資料函數（向後兼容）
        async function manualSaveData() {
            await SyncManager.manualSave();
        }

        async function validateAndSync(data) {
            try {
                console.log('🔍 開始驗證 Token 和同步...');
                
                // 驗證 Token
                const validation = await SimpleGitHubSync.validateToken();
                console.log('🔍 Token 驗證結果:', validation);
                
                if (!validation.valid) {
                    throw new Error(validation.message);
                }
                
                showSyncStatus('🔄 正在同步到 GitHub...');
                
                // 同步到 GitHub
                const result = await SimpleGitHubSync.syncData(data);
                console.log('✅ 同步結果:', result);
                
                showSyncStatus('✅ 資料已同步到 GitHub！');
                
                // 靜默成功，只顯示狀態訊息
                console.log('✅ 同步成功:', result.commitUrl);
                
            } catch (error) {
                console.error('❌ 同步失敗詳細錯誤:', error);
                console.error('❌ 錯誤堆疊:', error.stack);
                
                // 提供更詳細的錯誤訊息
                let errorMessage = error.message;
                if (error.message.includes('401')) {
                    errorMessage = 'Token 無效或已過期，請檢查 GitHub Token';
                } else if (error.message.includes('403')) {
                    errorMessage = '權限不足，請確認 Token 有 repo 權限';
                } else if (error.message.includes('404')) {
                    errorMessage = '找不到倉庫或檔案，請檢查專案設定';
                } else if (error.message.includes('CORS')) {
                    errorMessage = '網路連線問題，請檢查網路設定';
                }
                
                showSyncStatus(`❌ 同步失敗：${errorMessage}`);
                
                // 移除自動下載檔案功能
            }
        }
        
        function autoSaveData() {
            console.log('🔄 資料已更新（未同步）');
        }
        
        function updateDataJsonAndPush(data) {
            // 已移除自動下載和彈出視窗功能
            console.log('📄 資料已更新，但未自動下載檔案');
            showSyncStatus('📄 資料已更新到本地');
        }

        function showSyncStatus(message) {
            const syncStatus = document.getElementById('syncStatus');
            const syncMessage = document.getElementById('syncMessage');
            
            syncMessage.textContent = message;
            syncStatus.style.display = 'block';
            
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 3000);
        }

        function saveFoodTruckData() {
            const data = {
                foodTrucks: foodTruckDatabase,
                lastUpdated: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            autoSaveData();
            showAlert('資料已匯出為data.json並儲存到本地', 'success');
        }

        function updateStats() {
            const total = foodTruckDatabase.length;
            const active = foodTruckDatabase.filter(t => t.isActive).length;
            const inactive = total - active;
            
            // 移除了統計卡片的更新，因為已經刪除了統計區域
            console.log(`統計更新: 總數${total}, 已上架${active}, 已下架${inactive}`);
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alertMessage');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // 確保 foodTruckDatabase 有資料
            if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                console.log('⚠️ foodTruckDatabase 為空，無法篩選');
                filteredTrucks = [];
                renderTruckCards();
                updateStats();
                return;
            }

            filteredTrucks = foodTruckDatabase.filter(truck => {
                const matchesSearch = truck.title.toLowerCase().includes(searchTerm) || 
                                    truck.alt.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || 
                                    (statusFilter === 'active' && truck.isActive) ||
                                    (statusFilter === 'inactive' && !truck.isActive);
                return matchesSearch && matchesStatus;
            });

            filteredTrucks.sort((a, b) => {
                switch(sortBy) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'id':
                        return a.id.localeCompare(b.id);
                    case 'priority':
                    default:
                        return a.priority - b.priority;
                }
            });

            console.log(`🔍 篩選結果: ${filteredTrucks.length} 個餐車`);
            renderTruckCards();
            updateStats();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('sortBy').value = 'priority';
            
            // 確保 foodTruckDatabase 有資料
            if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                console.log('⚠️ foodTruckDatabase 為空，無法清除篩選');
                filteredTrucks = [];
            } else {
                filteredTrucks = [...foodTruckDatabase];
            }
            
            console.log(`🔄 清除篩選: ${filteredTrucks.length} 個餐車`);
            renderTruckCards();
            updateStats();
        }

        function showImageModal(src, alt, link = '') {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = src;
            modalImage.alt = alt;
            
            if (link) {
                modalImage.style.cursor = 'pointer';
                modalImage.onclick = function() {
                    window.open(link, '_blank');
                };
            } else {
                modalImage.style.cursor = 'default';
                modalImage.onclick = null;
            }
            
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        function toggleTruckSelection(truckId) {
            if (selectedTrucks.has(truckId)) {
                selectedTrucks.delete(truckId);
            } else {
                selectedTrucks.add(truckId);
            }
            updateBatchActions();
            renderTruckCards();
        }

        function updateBatchActions() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedTrucks.size > 0) {
                batchActions.classList.add('show');
                selectedCount.textContent = selectedTrucks.size;
            } else {
                batchActions.classList.remove('show');
            }
        }

        async function batchToggle(isActive) {
            if (selectedTrucks.size === 0) return;
            
            let count = 0;
            selectedTrucks.forEach(truckId => {
                const truck = foodTruckDatabase.find(t => t.id === truckId);
                if (truck) {
                    truck.isActive = isActive;
                    count++;
                }
            });
            
            // 即時更新本地儲存
            saveDataToLocal();
            
            showAlert(`已${isActive ? '上架' : '下架'} ${count} 個餐車`, 'success');
            clearSelection();
            applyFilters();
            
            // 自動同步到遠端（如果已設定 Token）
            try {
                const status = SimpleGitHubSync.getProjectStatus();
                if (status.hasToken) {
                    console.log('🔄 自動同步批量狀態變更到遠端...');
                    await manualSaveData();
                }
            } catch (error) {
                console.log('⚠️ 自動同步失敗，但本地已儲存');
            }
        }

        function clearSelection() {
            selectedTrucks.clear();
            updateBatchActions();
            renderTruckCards();
        }

        async function batchDelete() {
            if (selectedTrucks.size === 0) return;
            
            const confirmDelete = confirm(`確定要刪除選中的 ${selectedTrucks.size} 個餐車嗎？\n\n此操作無法復原！`);
            if (confirmDelete) {
                let count = 0;
                const truckIdsToDelete = Array.from(selectedTrucks);
                
                truckIdsToDelete.forEach(truckId => {
                    const index = foodTruckDatabase.findIndex(t => t.id === truckId);
                    if (index > -1) {
                        foodTruckDatabase.splice(index, 1);
                        count++;
                    }
                });
                
                foodTruckDatabase.forEach((t, idx) => {
                    t.priority = idx + 1;
                });
                
                // 即時更新本地儲存
                saveDataToLocal();
                
                showAlert(`已刪除 ${count} 個餐車`, 'success');
                clearSelection();
                applyFilters();
                renderPreview();
                
                // 自動同步到遠端（如果已設定 Token）
                try {
                    const status = SimpleGitHubSync.getProjectStatus();
                    if (status.hasToken) {
                        console.log('🔄 自動同步批量刪除到遠端...');
                        await manualSaveData();
                    }
                } catch (error) {
                    console.log('⚠️ 自動同步失敗，但本地已儲存');
                }
            }
        }

        async function deleteTruck(truckId) {
            const truck = foodTruckDatabase.find(t => t.id === truckId);
            if (truck) {
                const confirmDelete = confirm(`確定要刪除餐車 "${truck.title}" 嗎？\n\n此操作無法復原！`);
                if (confirmDelete) {
                    const index = foodTruckDatabase.findIndex(t => t.id === truckId);
                    if (index > -1) {
                        foodTruckDatabase.splice(index, 1);
                        
                        foodTruckDatabase.forEach((t, idx) => {
                            t.priority = idx + 1;
                        });
                        
                        // 即時更新本地儲存
                        saveDataToLocal();
                        
                        showAlert(`餐車 "${truck.title}" 已刪除`, 'success');
                        updateStats();
                        applyFilters();
                        renderPreview();
                        
                        // 自動同步到遠端（如果已設定 Token）
                        try {
                            const status = SimpleGitHubSync.getProjectStatus();
                            if (status.hasToken) {
                                console.log('🔄 自動同步刪除到遠端...');
                                await manualSaveData();
                            }
                        } catch (error) {
                            console.log('⚠️ 自動同步失敗，但本地已儲存');
                        }
                    }
                }
            }
        }

        function renderTruckCards() {
            const grid = document.getElementById('truckGrid');
            if (!grid) {
                console.error('❌ 找不到 truckGrid 元素');
                return;
            }
            
            grid.innerHTML = '';
            
            // 確保 foodTruckDatabase 有資料
            if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                console.log('⚠️ foodTruckDatabase 為空，顯示空狀態');
                grid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">暫無餐車資料</div>';
                return;
            }
            
            // 確保 filteredTrucks 有資料
            if (!filteredTrucks || filteredTrucks.length === 0) {
                console.log('⚠️ filteredTrucks 為空，重新初始化');
                filteredTrucks = [...foodTruckDatabase];
            }
            
            console.log(`🖼️ 渲染 ${filteredTrucks.length} 個餐車卡片 (總共 ${foodTruckDatabase.length} 個)`);
            
            filteredTrucks.forEach(truck => {
                const isSelected = selectedTrucks.has(truck.id);
                const isEditing = truck.isEditing || false;
                const card = document.createElement('div');
                card.className = `truck-card ${truck.isActive ? 'active' : 'inactive'} ${isSelected ? 'selected' : ''} ${isEditing ? 'editing' : ''}`;
                
                let linkButtons = '';
                let editLinksHTML = '';
                
                if (isEditing) {
                    // 編輯模式的連結輸入
                    const links = Array.isArray(truck.link) ? truck.link : [];
                    editLinksHTML = `
                        <div class="edit-links-container">
                            ${[1,2,3].map(i => {
                                const link = links[i-1] || { text: '', url: '' };
                                return `
                                    <div class="edit-link-group">
                                        <div>
                                            <div class="edit-link-label">按鈕${i}</div>
                                            <input type="text" class="truck-link-input" 
                                                   id="edit-text-${truck.id}-${i}" 
                                                   value="${link.text || ''}" 
                                                   placeholder="文字" maxlength="10">
                                        </div>
                                        <div>
                                            <div class="edit-link-label">網址${i}</div>
                                            <input type="url" class="truck-link-input" 
                                                   id="edit-url-${truck.id}-${i}" 
                                                   value="${link.url || ''}" 
                                                   placeholder="https://...">
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    // 顯示模式的連結按鈕
                    if (truck.link && Array.isArray(truck.link)) {
                        linkButtons = truck.link.map(link => 
                            `<a href="${link.url}" target="_blank" class="truck-link-btn">${link.text}</a>`
                        ).join('');
                    }
                }
                
                card.innerHTML = `
                    <div class="truck-image-container">
                        <div class="truck-priority-badge">#${truck.priority}</div>
                        <input type="checkbox" class="truck-checkbox" ${isSelected ? 'checked' : ''} 
                               onchange="toggleTruckSelection('${truck.id}')">
                        <img src="${truck.src}" alt="${truck.alt}" class="truck-image" 
                             onclick="showImageModal('${truck.src}', '${truck.alt}', '${truck.imgLink || ''}')"
                             onerror="this.src='https://via.placeholder.com/200x120/e2e8f0/64748b?text=圖片載入失敗'">
                        <div class="move-buttons">
                            <button class="move-btn" onclick="moveTruck('${truck.id}', 'up')" title="上移">↑</button>
                            <button class="move-btn" onclick="moveTruck('${truck.id}', 'down')" title="下移">↓</button>
                        </div>
                    </div>
                    
                    <div class="truck-info">
                        ${isEditing ? `
                            <input type="text" class="truck-title-input" 
                                   id="edit-title-${truck.id}" 
                                   value="${truck.title}" placeholder="餐車名稱">
                            <textarea class="truck-alt-input" 
                                      id="edit-alt-${truck.id}" 
                                      placeholder="圖片描述">${truck.alt}</textarea>
                            ${editLinksHTML}
                        ` : `
                            <div class="truck-title" onclick="editTitle('${truck.id}')" title="點擊編輯">${truck.title}</div>
                            <div class="truck-alt">${truck.alt}</div>
                            ${linkButtons ? `<div class="truck-links">${linkButtons}</div>` : ''}
                        `}
                        
                        <div class="truck-actions">
                            <div>
                                <span class="status-badge status-${truck.isActive ? 'active' : 'inactive'}">
                                    ${truck.isActive ? '已上架' : '已下架'}
                                </span>
                            </div>
                            <div style="display: flex; gap: 0.25rem;">
                                ${truck.isActive ? 
                                    `<button class="btn btn-danger btn-sm" onclick="toggleTruck('${truck.id}')">下架</button>` :
                                    `<button class="btn btn-success btn-sm" onclick="toggleTruck('${truck.id}')">上架</button>`
                                }
                                ${isEditing ? 
                                    `<button class="btn btn-success btn-sm" onclick="saveTruckEdit('${truck.id}')">儲存</button>
                                     <button class="btn btn-secondary btn-sm" onclick="cancelTruckEdit('${truck.id}')">取消</button>` :
                                    `<button class="btn btn-warning btn-sm" onclick="startTruckEdit('${truck.id}')">編輯</button>`
                                }
                                <button class="btn btn-danger btn-sm" onclick="deleteTruck('${truck.id}')">刪除</button>
                            </div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // ==================== 編輯函數（使用新的 EditManager） ====================

        // 開始編輯模式
        function startTruckEdit(truckId) {
            if (EditManager.startEdit(truckId)) {
                renderTruckCards();
            }
        }

        // 儲存編輯
        async function saveTruckEdit(truckId) {
            const success = await EditManager.saveEdit(truckId);
            if (success) {
            const truck = foodTruckDatabase.find(t => t.id === truckId);
            showAlert(`餐車 "${truck.title}" 已更新並儲存`, 'success');
            renderTruckCards();
            renderPreview();
            
            // 自動同步到遠端（如果已設定 Token）
            try {
                const status = SimpleGitHubSync.getProjectStatus();
                if (status.hasToken) {
                    console.log('🔄 自動同步編輯變更到遠端...');
                    await manualSaveData();
                }
            } catch (error) {
                console.log('⚠️ 自動同步失敗，但本地已儲存');
                }
            }
        }

        // 取消編輯
        function cancelTruckEdit(truckId) {
            if (EditManager.cancelEdit(truckId)) {
                renderTruckCards();
            }
        }

        // 簡化原有的編輯函數
        function editTruck(truckId) {
            startTruckEdit(truckId);
        }

        function renderPreview() {
            const preview = document.getElementById('marqueePreview');
            const activeTrucks = foodTruckDatabase.filter(t => t.isActive).sort((a, b) => a.priority - b.priority);
            
            preview.innerHTML = '';
            
            if (activeTrucks.length === 0) {
                console.log('🖼️ 沒有活躍的餐車，預覽為空');
                return;
            }
            
            activeTrucks.forEach(truck => {
                const item = document.createElement('div');
                item.className = 'marquee-item-preview';
                item.innerHTML = `<img src="${truck.src}" alt="${truck.alt}" onerror="this.src='https://via.placeholder.com/80x60/cccccc/666666?text=圖片載入失敗'">`;
                preview.appendChild(item);
            });
            
            console.log(`🖼️ 預覽已更新，顯示 ${activeTrucks.length} 個餐車`);
        }

        async function toggleTruck(truckId) {
            const truck = foodTruckDatabase.find(t => t.id === truckId);
            if (truck) {
                truck.isActive = !truck.isActive;
                
                // 即時更新本地儲存
                saveDataToLocal();
                
                showAlert(`餐車 "${truck.title}" 已${truck.isActive ? '上架' : '下架'}`, 'success');
                updateStats();
                applyFilters();
                renderPreview();
                
                // 自動同步到遠端（如果已設定 Token）
                try {
                    const status = SimpleGitHubSync.getProjectStatus();
                    if (status.hasToken) {
                        console.log('🔄 自動同步狀態變更到遠端...');
                        await manualSaveData();
                    }
                } catch (error) {
                    console.log('⚠️ 自動同步失敗，但本地已儲存');
                }
            }
        }

        async function editTitle(truckId) {
            const truck = foodTruckDatabase.find(t => t.id === truckId);
            if (!truck) return;
            
            const newTitle = prompt('請輸入餐車名稱:', truck.title || '');
            if (newTitle !== null && newTitle.trim() !== '') {
                truck.title = newTitle.trim();
                
                // 即時更新本地儲存
                saveDataToLocal();
                
                showAlert('餐車名稱已更新並儲存', 'success');
                applyFilters();
                
                // 自動同步到遠端（如果已設定 Token）
                try {
                    const status = SimpleGitHubSync.getProjectStatus();
                    if (status.hasToken) {
                        console.log('🔄 自動同步標題變更到遠端...');
                        await manualSaveData();
                    }
                } catch (error) {
                    console.log('⚠️ 自動同步失敗，但本地已儲存');
                }
            }
        }

        async function moveTruck(truckId, direction) {
            const truck = foodTruckDatabase.find(t => t.id === truckId);
            if (truck) {
                const currentIndex = foodTruckDatabase.findIndex(t => t.id === truckId);
                const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                
                if (newIndex >= 0 && newIndex < foodTruckDatabase.length) {
                    [foodTruckDatabase[currentIndex], foodTruckDatabase[newIndex]] = 
                    [foodTruckDatabase[newIndex], foodTruckDatabase[currentIndex]];
                    
                    foodTruckDatabase.forEach((t, index) => {
                        t.priority = index + 1;
                    });
                    
                    // 即時更新本地儲存
                    saveDataToLocal();
                    
                    showAlert(`餐車 "${truck.title}" 已${direction === 'up' ? '上移' : '下移'}`, 'success');
                    applyFilters();
                    renderPreview();
                    
                    // 自動同步到遠端（如果已設定 Token）
                    try {
                        const status = SimpleGitHubSync.getProjectStatus();
                        if (status.hasToken) {
                            console.log('🔄 自動同步排序變更到遠端...');
                            await manualSaveData();
                        }
                    } catch (error) {
                        console.log('⚠️ 自動同步失敗，但本地已儲存');
                    }
                }
            }
        }

        function fillExample(text, url) {
            for (let i = 1; i <= 3; i++) {
                const textInput = document.getElementById(`newTruckText${i}`);
                const urlInput = document.getElementById(`newTruckLink${i}`);
                
                if (!textInput.value && !urlInput.value) {
                    textInput.value = text;
                    urlInput.value = url;
                    
                    textInput.style.background = 'rgba(16, 185, 129, 0.1)';
                    urlInput.style.background = 'rgba(16, 185, 129, 0.1)';
                    
                    setTimeout(() => {
                        textInput.style.background = '';
                        urlInput.style.background = '';
                    }, 1000);
                    
                    showAlert(`已填入範例：${text}`, 'success');
                    break;
                }
            }
        }

        function openPostimageUpload() {
            window.open('https://postimages.org/', '_blank');
            showAlert('已開啟 Postimage 上傳頁面', 'success');
        }

        // 設定 GitHub Token
        function setupGitHubToken() {
            // 直接設定提供的 Token
            const token = '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';
            SimpleProjectConfig.setGitHubToken(token);
            showAlert('✅ GitHub Token 已設定！同步功能已啟用', 'success');
            
            // 測試 Token 是否有效
            testGitHubToken();
        }
        
        // 測試 GitHub Token
        async function testGitHubToken() {
            try {
                showSyncStatus('🔄 正在測試 GitHub Token...');
                
                const validation = await SimpleGitHubSync.validateToken();
                
                if (validation.valid) {
                    showSyncStatus('✅ GitHub Token 驗證成功！');
                    console.log('✅ GitHub Token 有效，使用者:', validation.user?.login);
                } else {
                    showSyncStatus('❌ GitHub Token 驗證失敗');
                    console.error('❌ GitHub Token 無效:', validation.message);
                }
            } catch (error) {
                console.error('❌ Token 測試失敗:', error);
                showSyncStatus('❌ Token 測試失敗');
            }
        }
        
        // 開啟 Token 設定頁面
        function openTokenSetup() {
            window.open('setup-github-token.html', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
        }

        // 檢查遠端更新
        async function checkForUpdates() {
            try {
                showSyncStatus('🔄 正在檢查遠端更新...');
                
                const status = SimpleGitHubSync.getProjectStatus();
                if (!status.hasToken) {
                    showAlert('請先設定 GitHub Token', 'danger');
                    return;
                }

                const updateInfo = await SimpleGitHubSync.checkForUpdates('data.json');
                
                if (updateInfo.hasUpdate) {
                    const shouldUpdate = confirm(
                        `發現遠端更新！\n\n` +
                        `遠端 SHA: ${updateInfo.remoteSha.substring(0, 8)}...\n` +
                        `本地 SHA: ${updateInfo.localSha ? updateInfo.localSha.substring(0, 8) + '...' : '無'}\n` +
                        `更新時間: ${new Date(updateInfo.lastModified).toLocaleString('zh-TW')}\n\n` +
                        `是否要下載遠端更新？`
                    );
                    
                    if (shouldUpdate) {
                        await pullRemoteData();
                    }
                } else {
                    showSyncStatus('✅ 已是最新版本');
                }
            } catch (error) {
                console.error('檢查更新失敗:', error);
                showAlert(`檢查更新失敗：${error.message}`, 'danger');
            }
        }

        // 從遠端拉取資料
        async function pullRemoteData() {
            try {
                showSyncStatus('🔄 正在下載遠端資料...');
                
                const result = await SimpleGitHubSync.pullData('data.json');
                const data = JSON.parse(result.content);
                
                // 更新本地資料
                foodTruckDatabase = data.foodTrucks;
                filteredTrucks = [...foodTruckDatabase];
                
                // 儲存到本地
                saveDataToLocal();
                
                showAlert('已從遠端更新資料', 'success');
                applyFilters();
                renderPreview();
                showSyncStatus('✅ 遠端資料已同步');
                
            } catch (error) {
                console.error('拉取遠端資料失敗:', error);
                showAlert(`拉取遠端資料失敗：${error.message}`, 'danger');
            }
        }

        // 調試函數：檢查資料狀態
        function debugDataStatus() {
            console.log('🔍 資料狀態檢查:');
            console.log(`  foodTruckDatabase: ${foodTruckDatabase ? foodTruckDatabase.length : 'undefined'} 個餐車`);
            console.log(`  filteredTrucks: ${filteredTrucks ? filteredTrucks.length : 'undefined'} 個餐車`);
            console.log(`  selectedTrucks: ${selectedTrucks ? selectedTrucks.size : 'undefined'} 個選中`);
            
            // 檢查 localStorage 中的資料
            const localData = localStorage.getItem('foodTruckData');
            if (localData) {
                try {
                    const data = JSON.parse(localData);
                    console.log('📱 localStorage 資料:');
                    console.log(`  最後更新: ${data.lastUpdated}`);
                    console.log(`  版本: ${data.version}`);
                    console.log(`  同步計數: ${data.syncCount}`);
                    console.log(`  餐車數量: ${data.foodTrucks ? data.foodTrucks.length : 0}`);
                    
                    if (data.foodTrucks) {
                        const editingTrucks = data.foodTrucks.filter(truck => truck.isEditing);
                        console.log(`  正在編輯的餐車: ${editingTrucks.length} 個`);
                        editingTrucks.forEach(truck => {
                            console.log(`    - ${truck.title} (ID: ${truck.id})`);
                        });
                    }
                } catch (error) {
                    console.error('❌ 解析 localStorage 資料失敗:', error);
                }
            } else {
                console.log('📱 localStorage 中沒有 foodTruckData');
            }
            
            if (foodTruckDatabase && foodTruckDatabase.length > 0) {
                console.log('  餐車列表:');
                foodTruckDatabase.forEach((truck, index) => {
                    console.log(`    ${index + 1}. ${truck.title} (${truck.isActive ? '已上架' : '已下架'}) ${truck.isEditing ? '[編輯中]' : ''}`);
                });
            }
            
            // 顯示在頁面上
            const status = `資料狀態: 總共 ${foodTruckDatabase ? foodTruckDatabase.length : 0} 個餐車, 篩選後 ${filteredTrucks ? filteredTrucks.length : 0} 個餐車`;
            showAlert(status, 'info');
        }
        
        // 清除本地資料
        function clearLocalData() {
            if (confirm('確定要清除所有本地資料嗎？這會強制從 data.json 重新載入。')) {
                localStorage.removeItem('foodTruckData');
                sessionStorage.removeItem('foodTruckData');
                console.log('🗑️ 本地資料已清除');
                alert('本地資料已清除，頁面將重新載入');
                location.reload();
            }
        }
        
        // 測試 data.json 載入
        async function testDataJsonLoad() {
            console.log('🧪 開始測試 data.json 載入...');
            
            try {
                // 直接測試 fetch data.json
                const response = await fetch('data.json?' + Date.now());
                console.log('📡 Fetch 回應狀態:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📄 解析的資料:', data);
                console.log(`📊 餐車數量: ${data.foodTrucks ? data.foodTrucks.length : 0}`);
                
                if (data && data.foodTrucks && Array.isArray(data.foodTrucks)) {
                    // 直接應用資料
                    foodTruckDatabase = [...data.foodTrucks];
                    filteredTrucks = [...foodTruckDatabase];
                    
                    // 重新渲染
                    renderTruckCards();
                    updateStats();
                    
                    alert(`✅ 成功載入 ${data.foodTrucks.length} 個餐車！`);
                    console.log('✅ data.json 載入測試成功');
                } else {
                    throw new Error('資料格式不正確');
                }
                
            } catch (error) {
                console.error('❌ data.json 載入測試失敗:', error);
                alert(`❌ 載入失敗: ${error.message}`);
            }
        }
        
        // 強制重新載入資料
        async function forceReloadData() {
            console.log('🔄 強制重新載入資料...');
            
            // 清除本地快取
            localStorage.removeItem('foodTruckData');
            sessionStorage.removeItem('foodTruckData');
            
            // 重新載入
            const loadResult = await loadFoodTruckData(true); // 強制從遠端載入
            console.log('📊 強制載入結果:', loadResult);
            
            // 強制渲染
            renderTruckCards();
            updateStats();
            
            alert(`✅ 強制重新載入完成！載入了 ${foodTruckDatabase ? foodTruckDatabase.length : 0} 個餐車`);
        }
        
        // 測試 F5 重新載入流程
        function testF5Reload() {
            console.log('🧪 測試 F5 重新載入流程...');
            
            // 1. 檢查 localStorage
            const localData = localStorage.getItem('foodTruckData');
            console.log('1. localStorage 檢查:', localData ? '有資料' : '無資料');
            
            if (localData) {
                try {
                    const data = JSON.parse(localData);
                    console.log('   - 餐車數量:', data.foodTrucks ? data.foodTrucks.length : 0);
                    console.log('   - 最後更新:', data.lastUpdated);
                    
                    if (data.foodTrucks) {
                        const editingCount = data.foodTrucks.filter(t => t.isEditing).length;
                        console.log('   - 編輯中的餐車:', editingCount);
                    }
                } catch (error) {
                    console.error('   - 解析失敗:', error);
                }
            }
            
            // 2. 檢查當前 foodTruckDatabase
            console.log('2. 當前 foodTruckDatabase:', foodTruckDatabase ? foodTruckDatabase.length : 'undefined');
            
            // 3. 模擬 loadFoodTruckData 流程
            console.log('3. 模擬載入流程...');
            const localDataFromManager = DataManager.loadFromLocal();
            console.log('   - DataManager.loadFromLocal():', localDataFromManager ? '成功' : '失敗');
            
            // 4. 檢查資料是否一致
            if (localData && localDataFromManager) {
                const localStorageCount = JSON.parse(localData).foodTrucks?.length || 0;
                const managerCount = localDataFromManager.foodTrucks?.length || 0;
                console.log('4. 資料一致性檢查:');
                console.log(`   - localStorage: ${localStorageCount} 個餐車`);
                console.log(`   - DataManager: ${managerCount} 個餐車`);
                console.log(`   - 是否一致: ${localStorageCount === managerCount ? '是' : '否'}`);
            }
        }
        
        // 強制重新載入本地資料
        function forceReloadLocalData() {
            console.log('🔄 強制重新載入本地資料...');
            
            const localData = DataManager.loadFromLocal();
            if (localData) {
                console.log('✅ 找到本地資料，強制應用...');
                LoadStrategy.applyLocalData(localData);
                
                // 更新介面
                filteredTrucks = [...foodTruckDatabase];
                updateStats();
                applyFilters();
                renderPreview();
                
                console.log('✅ 本地資料已強制載入並更新介面');
                showAlert('已強制載入本地資料', 'success');
            } else {
                console.log('❌ 沒有找到本地資料');
                showAlert('沒有找到本地資料', 'warning');
            }
        }
        
        // 測試本地儲存功能
        function testLocalSave() {
            console.log('🧪 測試本地儲存功能...');
            
            // 1. 檢查當前資料
            console.log('1. 當前 foodTruckDatabase 狀態:');
            console.log(`   - 餐車數量: ${foodTruckDatabase ? foodTruckDatabase.length : 'undefined'}`);
            if (foodTruckDatabase && foodTruckDatabase.length > 0) {
                console.log(`   - 第一個餐車: ${foodTruckDatabase[0].title}`);
            }
            
            // 2. 嘗試儲存
            console.log('2. 嘗試儲存到本地...');
            const savedData = DataManager.saveToLocal();
            console.log('   - 儲存結果:', savedData ? '成功' : '失敗');
            if (savedData) {
                console.log(`   - 儲存的餐車數量: ${savedData.foodTrucks.length}`);
                console.log(`   - 最後更新時間: ${savedData.lastUpdated}`);
            }
            
            // 3. 檢查 localStorage
            console.log('3. 檢查 localStorage...');
            const storedData = localStorage.getItem('foodTruckData');
            if (storedData) {
                try {
                    const parsed = JSON.parse(storedData);
                    console.log(`   - localStorage 中的餐車數量: ${parsed.foodTrucks ? parsed.foodTrucks.length : 'undefined'}`);
                    console.log(`   - localStorage 中的最後更新: ${parsed.lastUpdated}`);
                } catch (error) {
                    console.error('   - 解析 localStorage 失敗:', error);
                }
            } else {
                console.log('   - localStorage 中沒有資料');
            }
            
            // 4. 嘗試重新載入
            console.log('4. 嘗試重新載入...');
            const reloadedData = DataManager.loadFromLocal();
            console.log('   - 重新載入結果:', reloadedData ? '成功' : '失敗');
            if (reloadedData) {
                console.log(`   - 重新載入的餐車數量: ${reloadedData.foodTrucks.length}`);
            }
            
            showAlert('本地儲存測試完成，請查看控制台', 'info');
        }

        // 強制重新載入資料
        async function forceReloadData() {
            console.log('🔄 強制重新載入資料...');
            
            try {
                // 1. 清除快取
                localStorage.removeItem('foodTruckData');
                sessionStorage.removeItem('foodTruckData');
                console.log('🗑️ 已清除本地快取');
                
                // 2. 強制從遠端載入資料
                const result = await loadFoodTruckData(true); // 強制遠端載入
                console.log(`📊 載入結果:`, result);
                
                // 3. 獨立初始化資料
                const initResult = initializeData();
                console.log(`🔧 初始化結果:`, initResult);
                
                // 4. 強制重新渲染
                updateStats();
                applyFilters();
                renderPreview();
                
                // 5. 顯示結果
                if (initResult.hasData) {
                    showAlert(`✅ 資料已重新載入: ${initResult.foodTruckCount} 個餐車`, 'success');
                } else {
                    showAlert('⚠️ 載入失敗，使用預設資料', 'warning');
                }
                
            } catch (error) {
                console.error('❌ 重新載入失敗:', error);
                
                // 即使失敗也要確保有資料顯示
                const initResult = initializeData();
                updateStats();
                applyFilters();
                renderPreview();
                
                showAlert(`❌ 重新載入失敗: ${error.message}，使用預設資料`, 'danger');
            }
        }
        
        // 測試同步功能
        async function testSyncFunction() {
            console.log('🧪 開始測試同步功能...');
            showSyncStatus('🧪 正在測試同步功能...');
            
            try {
                // 0. 檢查模組是否載入
                // 使用內建的簡化版同步功能
                
                if (typeof SimpleProjectConfig === 'undefined') {
                    throw new Error('專案設定模組未載入，內建功能失敗');
                }
                
                // 1. 檢查專案狀態
                const status = SimpleGitHubSync.getProjectStatus();
                console.log('📊 專案狀態:', status);
                
                // 2. 測試專案設定
                const project = SimpleProjectConfig.getCurrentProject();
                console.log('📁 當前專案:', project);
                
                if (!project || !project.repository) {
                    showSyncStatus('❌ 專案設定不完整');
                    return;
                }
                
                // 3. 檢查 CORS 問題
                console.log('🌐 測試 GitHub API 連線...');
                try {
                    const testResponse = await fetch('https://api.github.com/zen');
                    console.log('✅ GitHub API 連線正常');
                } catch (corsError) {
                    console.error('❌ CORS 錯誤:', corsError);
                    showSyncStatus('❌ GitHub API CORS 限制');
                    
                    // 提供替代方案
                    const message = `同步測試失敗：\n\n` +
                        `❌ GitHub API CORS 限制\n\n` +
                        `💡 解決方案：\n` +
                        `1. 使用瀏覽器擴展（如 CORS Unblock）\n` +
                        `2. 使用代理服務器\n` +
                        `3. 手動上傳 data.json 到 GitHub\n\n` +
                        `🔗 您的倉庫：${project.website}`;
                    
                    alert(message);
                    return;
                }
                
                // 4. 測試 Token 驗證
                console.log('🔍 測試 Token 驗證...');
                const validation = await SimpleGitHubSync.validateToken();
                console.log('🔍 Token 驗證結果:', validation);
                
                if (!validation.valid) {
                    showSyncStatus(`❌ Token 驗證失敗: ${validation.message}`);
                    return;
                }
                
                // 5. 測試同步（使用當前資料）
                console.log('🔄 測試同步到 GitHub...');
                const data = DataManager.saveToLocal();
                const result = await SimpleGitHubSync.syncData(data);
                
                console.log('✅ 同步測試成功:', result);
                showSyncStatus('✅ 同步功能測試成功！');
                
                // 顯示成功訊息
                setTimeout(() => {
                    const message = `同步測試成功！\n\n` +
                        `📝 提交訊息：${result.commitMessage}\n` +
                        `🔗 查看提交：${result.commitUrl}\n` +
                        `🌐 網站：${project.website}`;
                    
                    alert(message);
                }, 1000);
                
            } catch (error) {
                console.error('❌ 同步測試失敗:', error);
                
                // 提供詳細的錯誤診斷
                let diagnosticMessage = `同步測試失敗：\n\n`;
                
                if (error.message.includes('401')) {
                    diagnosticMessage += '❌ Token 無效或已過期\n';
                    diagnosticMessage += '💡 請檢查 GitHub Token 是否正確\n';
                } else if (error.message.includes('403')) {
                    diagnosticMessage += '❌ 權限不足\n';
                    diagnosticMessage += '💡 請確認 Token 有 repo 權限\n';
                } else if (error.message.includes('404')) {
                    diagnosticMessage += '❌ 找不到倉庫或檔案\n';
                    diagnosticMessage += '💡 請檢查專案設定和倉庫 URL\n';
                } else if (error.message.includes('CORS') || error.name === 'TypeError') {
                    diagnosticMessage += '❌ CORS 跨域限制\n\n';
                    diagnosticMessage += '💡 解決方案：\n';
                    diagnosticMessage += '1. 安裝瀏覽器擴展（CORS Unblock）\n';
                    diagnosticMessage += '2. 使用代理服務器\n';
                    diagnosticMessage += '3. 手動上傳 data.json\n';
                    diagnosticMessage += '4. 使用 GitHub CLI 工具\n\n';
                    diagnosticMessage += '🔗 您的倉庫：https://github.com/sky770825/niceshow';
                } else {
                    diagnosticMessage += `❌ ${error.message}\n`;
                }
                
                diagnosticMessage += `\n🔍 詳細錯誤請查看控制台`;
                
                showSyncStatus(`❌ 同步測試失敗: ${error.message}`);
                alert(diagnosticMessage);
            }
        }


        document.getElementById('addTruckForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('newTruckTitle').value;
            const src = document.getElementById('newTruckSrc').value;
            const alt = document.getElementById('newTruckAlt').value || title;
            const imgLink = document.getElementById('newTruckImgLink').value.trim();
            
            const link1 = document.getElementById('newTruckLink1').value.trim();
            const link2 = document.getElementById('newTruckLink2').value.trim();
            const link3 = document.getElementById('newTruckLink3').value.trim();
            
            const text1 = document.getElementById('newTruckText1').value.trim() || '官網';
            const text2 = document.getElementById('newTruckText2').value.trim() || 'FB';
            const text3 = document.getElementById('newTruckText3').value.trim() || 'IG';
            
            const linkData = [];
            if (link1) linkData.push({ url: link1, text: text1 });
            if (link2) linkData.push({ url: link2, text: text2 });
            if (link3) linkData.push({ url: link3, text: text3 });
            
            const newTruck = {
                id: `truck_${Date.now()}`,
                src: src,
                alt: alt,
                title: title,
                imgLink: imgLink || '',
                link: linkData.length > 0 ? linkData : '',
                isActive: true,
                priority: foodTruckDatabase.length + 1,
                category: 'main'
            };
            
            foodTruckDatabase.push(newTruck);
            
            // 即時更新本地儲存
            saveDataToLocal();
            
            showAlert(`餐車 "${title}" 已新增並儲存`, 'success');
            
            document.getElementById('addTruckForm').reset();
            
            updateStats();
            applyFilters();
            renderPreview();
            
            // 自動同步到遠端（如果已設定 Token）
            try {
                const status = SimpleGitHubSync.getProjectStatus();
                if (status.hasToken) {
                    console.log('🔄 自動同步新增餐車到遠端...');
                    await manualSaveData();
                }
            } catch (error) {
                console.log('⚠️ 自動同步失敗，但本地已儲存');
            }
        });

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 頁面載入完成，開始初始化...');
            
            // 檢查模組是否正確載入
            setTimeout(() => {
                console.log('🔍 檢查模組載入狀態...');
                console.log('  - SimpleProjectConfig:', typeof SimpleProjectConfig !== 'undefined' ? '✅ 已載入' : '❌ 未載入');
                console.log('  - SimpleGitHubSync:', typeof SimpleGitHubSync !== 'undefined' ? '✅ 已載入' : '❌ 未載入');
                
                if (typeof SimpleProjectConfig === 'undefined') {
                    console.error('❌ SimpleProjectConfig 未載入，內建專案設定功能失敗');
                    showAlert('❌ 專案設定模組載入失敗', 'danger');
                }
                
                if (typeof SimpleGitHubSync === 'undefined') {
                    console.error('❌ SimpleGitHubSync 未載入，內建同步功能失敗');
                    showAlert('❌ GitHub 同步模組載入失敗', 'danger');
                }
            }, 100);
            
            // 立即檢查並修復載入問題
            setTimeout(async () => {
                if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                    console.log('🔧 檢測到沒有資料，嘗試強制載入...');
                    try {
                        const response = await fetch('data.json?' + Date.now());
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.foodTrucks && Array.isArray(data.foodTrucks)) {
                                foodTruckDatabase = [...data.foodTrucks];
                                filteredTrucks = [...foodTruckDatabase];
                                renderTruckCards();
                                updateStats();
                                console.log(`✅ 自動修復完成，載入 ${data.foodTrucks.length} 個餐車`);
                            }
                        }
                    } catch (error) {
                        console.log('⚠️ 自動修復失敗:', error.message);
                    }
                }
            }, 500);
            
            try {
                // 檢查模組是否載入
                if (typeof SimpleProjectConfig === 'undefined') {
                    throw new Error('SimpleProjectConfig 模組未載入');
                }
                
                // 使用內建的 SimpleGitHubSync
                
                // 1. 初始化專案設定
                SimpleProjectConfig.initialize();
                console.log('✅ 專案設定已初始化');
                
                // 1.5. 自動設定 GitHub Token
                const token = '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';
                SimpleProjectConfig.setGitHubToken(token);
                console.log('✅ GitHub Token 已自動設定');
                
                // 1.6. 測試 Token 是否有效
                try {
                    const validation = await SimpleGitHubSync.validateToken();
                    console.log('🔍 Token 驗證結果:', validation);
                    if (validation.valid) {
                        console.log('✅ Token 驗證成功，使用者:', validation.user?.login);
                    } else {
                        console.error('❌ Token 驗證失敗:', validation.message);
                    }
                } catch (error) {
                    console.error('❌ Token 驗證過程中發生錯誤:', error);
                }
                
                // 2. 載入餐車資料
                const loadResult = await loadFoodTruckData();
                console.log('📊 資料載入結果:', loadResult);
                console.log('📊 載入後的 foodTruckDatabase 長度:', foodTruckDatabase ? foodTruckDatabase.length : 'undefined');
                
                // 3. 檢查是否需要初始化（只有在沒有有效資料時才初始化）
                let initResult;
                if (!foodTruckDatabase || foodTruckDatabase.length === 0) {
                    console.log('⚠️ 沒有有效資料，執行初始化...');
                    initResult = initializeData();
                console.log('🔧 資料初始化結果:', initResult);
                } else {
                    console.log('✅ 已有有效資料，跳過初始化');
                    // 只初始化 filteredTrucks 和 selectedTrucks
                    filteredTrucks = [...foodTruckDatabase];
                    if (!selectedTrucks || !(selectedTrucks instanceof Set)) {
                        selectedTrucks = new Set();
                    }
                    initResult = {
                        foodTruckCount: foodTruckDatabase.length,
                        hasData: true,
                        filteredCount: filteredTrucks.length
                    };
                }
                
                // 4. 渲染介面
                console.log(`🖼️ 開始渲染介面: ${initResult.foodTruckCount} 個餐車`);
                updateStats();
                applyFilters();
                renderTruckCards(); // 渲染餐車卡片
                renderPreview();
                
                // 5. 檢查渲染結果，如果沒有顯示餐車，強制重新載入
                setTimeout(() => {
                    const truckCards = document.querySelectorAll('.truck-card');
                    if (truckCards.length === 0 && foodTruckDatabase && foodTruckDatabase.length > 0) {
                        console.log('⚠️ 檢測到資料已載入但沒有渲染，強制重新渲染...');
                        renderTruckCards();
                        updateStats();
                    }
                }, 1000);
                
                // 5. 顯示載入結果
                if (initResult.hasData) {
                    console.log(`✅ 初始化完成: ${initResult.foodTruckCount} 個餐車已載入`);
                } else {
                    console.log('⚠️ 初始化完成: 使用預設資料');
                }
                
            } catch (error) {
                console.error('❌ 初始化失敗:', error);
                
                // 即使初始化失敗，也要確保有基本功能
                const initResult = initializeData();
                updateStats();
                applyFilters();
                renderPreview();
                
                showAlert('初始化失敗，使用預設資料', 'warning');
            }
            
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applyFilters);
            
            document.querySelectorAll('.example-item').forEach(item => {
                item.addEventListener('click', function() {
                    this.classList.add('clicked');
                    setTimeout(() => {
                        this.classList.remove('clicked');
                    }, 300);
                });
            });
            
            document.addEventListener('keydown', function(e) {
                // 如果焦點在編輯模式的輸入框內，優先處理輸入框的 Ctrl+A
                if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                        e.preventDefault();
                        e.target.select();
                        return;
                    }
                }
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'a':
                            e.preventDefault();
                            if (selectedTrucks.size === filteredTrucks.length) {
                                clearSelection();
                            } else {
                                filteredTrucks.forEach(truck => selectedTrucks.add(truck.id));
                                updateBatchActions();
                                renderTruckCards();
                            }
                            break;
                        case 's':
                            e.preventDefault();
                            manualSaveData();
                            break;
                    }
                }
                
                if (e.key === 'Escape') {
                    hideImageModal();
                    clearSelection();
                }
            });
        });
    </script>
</body>
</html>
</html>