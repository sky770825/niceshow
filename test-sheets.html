<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets æ¸¬è©¦å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 5px solid #17a2b8;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 5px solid #ffc107;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
            font-size: 14px;
            line-height: 1.6;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .config-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid #007bff;
        }
        
        .config-info h3 {
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .config-info code {
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        h3 {
            color: #333;
            margin: 30px 0 15px 0;
            font-size: 1.5rem;
        }
        
        h4 {
            color: #666;
            margin: 20px 0 10px 0;
            font-size: 1.2rem;
        }
        
        p {
            line-height: 1.6;
            color: #666;
            margin: 10px 0;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Google Sheets æ¸¬è©¦å·¥å…·</h1>
            <p>æ¸¬è©¦é¤è»Šå ±åè¡¨ Google Sheets é€£æ¥èˆ‡è³‡æ–™æ ¼å¼</p>
        </div>
        
        <div class="content">
            <div class="config-info">
                <h3>ğŸ“‹ ç›®å‰è¨­å®š</h3>
                <p><strong>Sheet ID:</strong> <code id="displaySheetId">è¼‰å…¥ä¸­...</code></p>
                <p><strong>Sheet GID:</strong> <code id="displaySheetGid">è¼‰å…¥ä¸­...</code></p>
                <p><strong>CSV URL:</strong> <code id="displayCsvUrl" style="font-size: 12px; word-break: break-all;">è¼‰å…¥ä¸­...</code></p>
            </div>
            
            <div id="status"></div>
            
            <div class="button-group">
                <button onclick="testSheets()">ğŸ” æ¸¬è©¦ Google Sheets é€£æ¥</button>
                <button onclick="showRawData()" class="secondary">ğŸ“„ é¡¯ç¤ºåŸå§‹è³‡æ–™</button>
                <button onclick="showConvertedData()" class="secondary">ğŸ”„ é¡¯ç¤ºè½‰æ›å¾Œè³‡æ–™</button>
                <button onclick="clearResults()" class="secondary">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
            </div>
            
            <div id="result"></div>
        </div>
    </div>
    
    <script>
        const SHEET_ID = '1oS9zTU6DL_cCRnOI6A4ffAeXXn7fXkr6URxxMVprlG4';
        const SHEET_GID = '782323585';
        
        let rawData = null;
        let convertedData = null;
        
        // æ˜¾ç¤ºè®¾å®š
        document.getElementById('displaySheetId').textContent = SHEET_ID;
        document.getElementById('displaySheetGid').textContent = SHEET_GID;
        const csvURL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
        document.getElementById('displayCsvUrl').textContent = csvURL;
        
        async function testSheets() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            
            statusDiv.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨é€£æ¥ Google Sheets...<span class="loading"></span></div>';
            resultDiv.innerHTML = '';
            
            try {
                const response = await fetch(csvURL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\\n');
                
                statusDiv.innerHTML = `
                    <div class="success">
                        âœ… é€£æ¥æˆåŠŸï¼<span class="badge badge-success">${lines.length} è¡Œè³‡æ–™</span><br>
                        <small>Google Sheets å…¬é–‹è¨­å®šæ­£ç¢ºï¼Œå¯ä»¥æ­£å¸¸è®€å–è³‡æ–™</small>
                    </div>
                `;
                
                // è§£ææ•°æ®
                const rows = parseCSV(csvText);
                rawData = rows;
                
                // ç»Ÿè®¡
                const scheduledCount = rows.filter(r => r.status === 'å·±æ’ç­').length;
                const totalCount = rows.length;
                
                resultDiv.innerHTML = `
                    <h3>ğŸ“Š è³‡æ–™æ¦‚è¦½</h3>
                    <div class="config-info">
                        <p><strong>ç¸½è³‡æ–™ç­†æ•¸:</strong> ${totalCount}</p>
                        <p><strong>å·±æ’ç­æ•¸é‡:</strong> ${scheduledCount} <span class="badge badge-success">${Math.round(scheduledCount/totalCount*100)}%</span></p>
                        <p><strong>å¾…æ’/å…¶ä»–:</strong> ${totalCount - scheduledCount}</p>
                    </div>
                    <h4>è¡¨é ­:</h4>
                    <pre>${lines[0]}</pre>
                    <h4>å‰ 3 ç­†è³‡æ–™é è¦½:</h4>
                    <pre>${JSON.stringify(rows.slice(0, 3), null, 2)}</pre>
                `;
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">
                        âŒ é€£æ¥å¤±æ•—: ${error.message}<br><br>
                        <strong>å¯èƒ½åŸå› :</strong><br>
                        1. âŒ Google Sheets æœªè¨­ç‚ºå…¬é–‹ï¼ˆæ‡‰è©²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººã€å¯æª¢è¦–ï¼‰<br>
                        2. âŒ Sheet ID æˆ– GID è¨­å®šéŒ¯èª¤<br>
                        3. âŒ ç¶²è·¯é€£æ¥å•é¡Œ<br>
                        4. âŒ ç€è¦½å™¨é˜»æ“‹äº†è·¨åŸŸè«‹æ±‚ï¼ˆè«‹åœç”¨å»£å‘Šæ””æˆªå™¨ï¼‰
                    </div>
                `;
            }
        }
        
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\\n');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const cells = parseCSVLine(line);
                
                if (cells.length >= 5 && cells[1] && cells[4]) {
                    rows.push({
                        timestamp: cells[0],
                        storeName: cells[1].trim(),
                        type: cells[2] ? cells[2].trim() : '',
                        venue: cells[3] ? cells[3].trim() : '',
                        bookingDate: cells[4].trim(),
                        status: cells[5] ? cells[5].trim() : '',
                        fee: cells[6] ? cells[6].trim() : '',
                        paid: cells[7] ? cells[7].trim() : '',
                        note: cells[8] ? cells[8].trim() : ''
                    });
                }
            }
            
            return rows;
        }
        
        function parseCSVLine(line) {
            const cells = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cells.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            cells.push(current);
            
            return cells.map(cell => cell.replace(/^"|"$/g, '').trim());
        }
        
        function showRawData() {
            const resultDiv = document.getElementById('result');
            if (!rawData) {
                resultDiv.innerHTML = '<div class="warning">âš ï¸ è«‹å…ˆé»æ“Šã€Œæ¸¬è©¦ Google Sheets é€£æ¥ã€</div>';
                return;
            }
            
            let html = '<h3>ğŸ“„ åŸå§‹è³‡æ–™</h3>';
            html += '<table>';
            html += '<tr><th>#</th><th>åº—å</th><th>é¤è»Šé¡å‹</th><th>é ç´„å ´åœ°</th><th>é ç´„æ—¥æœŸ</th><th>å·±æ’</th><th>ç‹€æ…‹</th></tr>';
            
            rawData.forEach((row, index) => {
                const statusBadge = row.status === 'å·±æ’ç­' 
                    ? '<span class="badge badge-success">âœ“ æœƒé¡¯ç¤º</span>' 
                    : '<span class="badge badge-error">âœ— ä¸é¡¯ç¤º</span>';
                    
                html += `<tr>
                    <td>${index + 1}</td>
                    <td><strong>${row.storeName}</strong></td>
                    <td>${row.type}</td>
                    <td>${row.venue}</td>
                    <td>${row.bookingDate}</td>
                    <td>${row.status}</td>
                    <td>${statusBadge}</td>
                </tr>`;
            });
            
            html += '</table>';
            html += `
                <div class="config-info" style="margin-top: 20px;">
                    <h4>ğŸ’¡ é‡è¦æç¤ºï¼š</h4>
                    <p>åªæœ‰ã€Œå·±æ’ã€æ¬„ä½å¡«å¯« <code>å·±æ’ç­</code>ï¼ˆåŒ…å«ã€Œç­ã€å­—ï¼‰çš„é¤è»Šæ‰æœƒé¡¯ç¤ºåœ¨è¡Œç¨‹è¡¨ä¸Šï¼</p>
                </div>
            `;
            resultDiv.innerHTML = html;
        }
        
        function showConvertedData() {
            const resultDiv = document.getElementById('result');
            if (!rawData) {
                resultDiv.innerHTML = '<div class="warning">âš ï¸ è«‹å…ˆé»æ“Šã€Œæ¸¬è©¦ Google Sheets é€£æ¥ã€</div>';
                return;
            }
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const dateMap = new Map();
            let dateErrorCount = 0;
            let statusErrorCount = 0;
            
            rawData.forEach(booking => {
                const dateInfo = parseBookingDate(booking.bookingDate);
                if (!dateInfo) {
                    dateErrorCount++;
                    return;
                }
                
                const dateKey = `${dateInfo.month}-${dateInfo.day}`;
                
                if (!dateMap.has(dateKey)) {
                    dateMap.set(dateKey, {
                        date: dateInfo.date,
                        dayName: dateInfo.dayName,
                        month: dateInfo.month,
                        day: dateInfo.day,
                        trucks: []
                    });
                }
                
                if (booking.status === 'å·±æ’ç­') {
                    const address = extractAddress(booking.venue);
                    dateMap.get(dateKey).trucks.push({
                        name: booking.storeName,
                        venue: booking.venue,
                        address: address
                    });
                } else {
                    statusErrorCount++;
                }
            });
            
            const sortedDates = Array.from(dateMap.values()).sort((a, b) => {
                if (a.month !== b.month) return a.month - b.month;
                return a.day - b.day;
            });
            
            let html = '<h3>ğŸ”„ è½‰æ›å¾Œè³‡æ–™ï¼ˆæŒ‰æ—¥æœŸåˆ†çµ„ï¼‰</h3>';
            
            if (dateErrorCount > 0 || statusErrorCount > 0) {
                html += '<div class="warning">';
                if (dateErrorCount > 0) {
                    html += `âš ï¸ ${dateErrorCount} ç­†è³‡æ–™å› æ—¥æœŸæ ¼å¼éŒ¯èª¤è¢«è·³é<br>`;
                    html += '<small>æ­£ç¢ºæ ¼å¼ï¼š10æœˆ21æ—¥(æ˜ŸæœŸä¸€) æˆ– 10æœˆ21æ—¥ï¼ˆæ˜ŸæœŸä¸€ï¼‰</small><br><br>';
                }
                if (statusErrorCount > 0) {
                    html += `âš ï¸ ${statusErrorCount} ç­†è³‡æ–™å› ã€Œå·±æ’ã€æ¬„ä½ä¸æ˜¯ã€Œå·±æ’ç­ã€è€Œä¸æœƒé¡¯ç¤º<br>`;
                    html += '<small>è«‹ç¢ºèªã€Œå·±æ’ã€æ¬„ä½å¡«å¯«ã€Œå·±æ’ç­ã€ï¼ˆåŒ…å«ã€Œç­ã€å­—ï¼‰</small>';
                }
                html += '</div>';
            }
            
            html += `
                <div class="success" style="margin: 20px 0;">
                    âœ… æˆåŠŸè½‰æ› ${sortedDates.length} å¤©çš„é¤è»Šè³‡æ–™<br>
                    <small>å…± ${sortedDates.reduce((sum, day) => sum + day.trucks.length, 0)} å€‹é¤è»Šæœƒé¡¯ç¤ºåœ¨è¡Œç¨‹è¡¨ä¸Š</small>
                </div>
            `;
            
            html += '<table>';
            html += '<tr><th>æ—¥æœŸ</th><th>æ˜ŸæœŸ</th><th>é¤è»Šæ•¸é‡</th><th>é¤è»Šåˆ—è¡¨</th></tr>';
            
            sortedDates.forEach(day => {
                const truckNames = day.trucks.map(t => `${t.name} (${t.address})`).join('<br>');
                html += `<tr>
                    <td><strong>${day.date}</strong></td>
                    <td>${day.dayName}</td>
                    <td><span class="badge badge-success">${day.trucks.length}</span></td>
                    <td>${truckNames || '<em>ç„¡é¤è»Š</em>'}</td>
                </tr>`;
            });
            
            html += '</table>';
            resultDiv.innerHTML = html;
        }
        
        function extractAddress(venue) {
            if (!venue) return '';
            
            const addresses = [
                'å››ç¶­è·¯70è™Ÿ', 'å››ç¶­è·¯60è™Ÿ', 'å››ç¶­è·¯59è™Ÿ', 'å››ç¶­è·¯190è™Ÿ',
                'å››ç¶­è·¯216è™Ÿ', 'å››ç¶­è·¯218è™Ÿ', 'å››ç¶­è·¯72è™Ÿ', 'å››ç¶­è·¯77è™Ÿ'
            ];
            
            for (const address of addresses) {
                if (venue.includes(address)) {
                    return address;
                }
            }
            
            return venue;
        }
        
        function parseBookingDate(bookingDate) {
            if (!bookingDate) return null;
            
            const match = bookingDate.match(/(\\d+)æœˆ(\\d+)æ—¥[\\(ï¼ˆ]æ˜ŸæœŸ([ä¸€äºŒä¸‰å››äº”å…­æ—¥])[\\)ï¼‰]/);
            
            if (match) {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                const dayNameMap = {
                    'ä¸€': 'é€±ä¸€', 'äºŒ': 'é€±äºŒ', 'ä¸‰': 'é€±ä¸‰', 'å››': 'é€±å››',
                    'äº”': 'é€±äº”', 'å…­': 'é€±å…­', 'æ—¥': 'é€±æ—¥'
                };
                const dayName = dayNameMap[match[3]] || '';
                
                return {
                    date: `${month}/${day}`,
                    dayName: dayName,
                    month: month,
                    day: day
                };
            }
            
            return null;
        }
        
        function clearResults() {
            document.getElementById('status').innerHTML = '';
            document.getElementById('result').innerHTML = '';
            rawData = null;
            convertedData = null;
        }
    </script>
</body>
</html>

