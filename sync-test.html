<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同步功能測試頁面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 1rem;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            font-weight: 500;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .log {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 同步功能測試頁面</h1>
        <p>此頁面用於測試 GitHub 同步功能是否正常運作</p>
        
        <div id="status" class="status status-info">
            🔄 準備測試同步功能...
        </div>
        
        <div>
            <h3>🔧 基本功能測試</h3>
            <button class="btn" onclick="testProjectConfig()">測試專案設定</button>
            <button class="btn" onclick="testGitHubSync()">測試 GitHub 同步</button>
            <button class="btn btn-warning" onclick="testTokenValidation()">測試 Token 驗證</button>
            <button class="btn btn-success" onclick="testDataSync()">測試資料同步</button>
        </div>
        
        <div>
            <h3>🔄 同步功能測試</h3>
            <button class="btn" onclick="testCheckUpdates()">檢查遠端更新</button>
            <button class="btn" onclick="testPullData()">拉取遠端資料</button>
            <button class="btn btn-danger" onclick="clearLog()">清除日誌</button>
        </div>
        
        <div>
            <h3>📊 測試日誌</h3>
            <div id="log" class="log">等待測試開始...\n</div>
        </div>
    </div>

    <!-- 載入必要的模組 -->
    <script src="project-config.js"></script>
    <script src="github-sync.js"></script>
    
    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            statusElement.textContent = message;
            statusElement.className = `status status-${type}`;
        }
        
        function clearLog() {
            logElement.textContent = '日誌已清除\n';
        }
        
        // 測試專案設定
        function testProjectConfig() {
            log('🧪 開始測試專案設定...');
            
            try {
                const config = projectConfig.load();
                if (config) {
                    log(`✅ 專案設定載入成功: ${config.currentProject.name}`);
                    log(`📁 倉庫: ${config.currentProject.repository}`);
                    log(`🌐 網站: ${config.currentProject.website}`);
                    updateStatus('✅ 專案設定測試通過', 'success');
                } else {
                    throw new Error('專案設定載入失敗');
                }
            } catch (error) {
                log(`❌ 專案設定測試失敗: ${error.message}`);
                updateStatus('❌ 專案設定測試失敗', 'error');
            }
        }
        
        // 測試 GitHub 同步模組
        function testGitHubSync() {
            log('🧪 開始測試 GitHub 同步模組...');
            
            try {
                if (typeof githubSync === 'undefined') {
                    throw new Error('GitHub 同步模組未載入');
                }
                
                const status = githubSync.getProjectStatus();
                log(`📊 專案狀態: ${JSON.stringify(status, null, 2)}`);
                
                if (status.hasProject) {
                    log('✅ GitHub 同步模組載入成功');
                    updateStatus('✅ GitHub 同步模組測試通過', 'success');
                } else {
                    throw new Error('未找到專案設定');
                }
            } catch (error) {
                log(`❌ GitHub 同步模組測試失敗: ${error.message}`);
                updateStatus('❌ GitHub 同步模組測試失敗', 'error');
            }
        }
        
        // 測試 Token 驗證
        async function testTokenValidation() {
            log('🧪 開始測試 Token 驗證...');
            
            try {
                if (!githubSync.token) {
                    log('⚠️ 未設定 Token，請先設定');
                    updateStatus('⚠️ 請先設定 GitHub Token', 'error');
                    return;
                }
                
                log('🔄 正在驗證 Token...');
                const validation = await githubSync.validateToken();
                
                if (validation.valid) {
                    log(`✅ Token 驗證成功: ${validation.user}`);
                    updateStatus('✅ Token 驗證通過', 'success');
                } else {
                    log(`❌ Token 驗證失敗: ${validation.message}`);
                    updateStatus('❌ Token 驗證失敗', 'error');
                }
            } catch (error) {
                log(`❌ Token 驗證測試失敗: ${error.message}`);
                updateStatus('❌ Token 驗證測試失敗', 'error');
            }
        }
        
        // 測試資料同步
        async function testDataSync() {
            log('🧪 開始測試資料同步...');
            
            try {
                if (!githubSync.token) {
                    log('⚠️ 未設定 Token，跳過同步測試');
                    updateStatus('⚠️ 請先設定 GitHub Token', 'error');
                    return;
                }
                
                const testData = {
                    foodTrucks: [
                        {
                            id: 'test_truck_' + Date.now(),
                            title: '測試餐車',
                            src: 'https://via.placeholder.com/200x120/3b82f6/ffffff?text=測試圖片',
                            alt: '測試餐車圖片',
                            isActive: true,
                            priority: 1,
                            category: 'test'
                        }
                    ],
                    lastUpdated: new Date().toISOString()
                };
                
                log('🔄 正在同步測試資料...');
                const result = await githubSync.syncData(testData, 'test-data.json');
                
                log(`✅ 資料同步成功: ${result.commitUrl}`);
                updateStatus('✅ 資料同步測試通過', 'success');
            } catch (error) {
                log(`❌ 資料同步測試失敗: ${error.message}`);
                updateStatus('❌ 資料同步測試失敗', 'error');
            }
        }
        
        // 測試檢查更新
        async function testCheckUpdates() {
            log('🧪 開始測試檢查更新...');
            
            try {
                if (!githubSync.token) {
                    log('⚠️ 未設定 Token，跳過檢查更新測試');
                    updateStatus('⚠️ 請先設定 GitHub Token', 'error');
                    return;
                }
                
                log('🔄 正在檢查遠端更新...');
                const updateInfo = await githubSync.checkForUpdates('data.json');
                
                log(`📊 更新資訊: ${JSON.stringify(updateInfo, null, 2)}`);
                
                if (updateInfo.hasUpdate) {
                    log('🆕 發現遠端更新');
                    updateStatus('🆕 發現遠端更新', 'info');
                } else {
                    log('✅ 已是最新版本');
                    updateStatus('✅ 已是最新版本', 'success');
                }
            } catch (error) {
                log(`❌ 檢查更新測試失敗: ${error.message}`);
                updateStatus('❌ 檢查更新測試失敗', 'error');
            }
        }
        
        // 測試拉取資料
        async function testPullData() {
            log('🧪 開始測試拉取資料...');
            
            try {
                if (!githubSync.token) {
                    log('⚠️ 未設定 Token，跳過拉取資料測試');
                    updateStatus('⚠️ 請先設定 GitHub Token', 'error');
                    return;
                }
                
                log('🔄 正在拉取遠端資料...');
                const result = await githubSync.pullData('data.json');
                
                log(`✅ 資料拉取成功，大小: ${result.content.length} 字元`);
                log(`📝 SHA: ${result.sha}`);
                updateStatus('✅ 資料拉取測試通過', 'success');
            } catch (error) {
                log(`❌ 資料拉取測試失敗: ${error.message}`);
                updateStatus('❌ 資料拉取測試失敗', 'error');
            }
        }
        
        // 頁面載入時自動初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 同步功能測試頁面已載入');
            log('💡 請依序點擊按鈕進行測試');
            
            // 初始化專案設定
            if (typeof projectConfig !== 'undefined') {
                projectConfig.initialize();
                log('✅ 專案設定已初始化');
            }
        });
    </script>
</body>
</html>
